<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Main UI Statistical Tests</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        button { padding: 10px 20px; margin: 5px; }
        .chart-container { height: 200px; width: 100%; border: 1px solid #ddd; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üß™ Test Main UI Statistical Tests</h1>
    
    <div class="test-section">
        <h3>Test 1: Direct API Call (Same Port)</h3>
        <button onclick="testDirectAPI()">Test Direct API</button>
        <div id="direct-api-result" class="result"></div>
    </div>
    
    <div class="test-section">
        <h3>Test 2: Main UI Functions (Simulated)</h3>
        <button onclick="testMainUIFunctions()">Test Main UI Functions</button>
        <div id="main-ui-result" class="result">
            <div class="chart-container" id="main-ui-chart"></div>
        </div>
    </div>
    
    <div class="test-section">
        <h3>Test 3: Full Integration Test</h3>
        <button onclick="testFullIntegration()">Test Full Integration</button>
        <div id="integration-result" class="result"></div>
    </div>

    <script>
        // Test 1: Direct API Call
        async function testDirectAPI() {
            const resultDiv = document.getElementById('direct-api-result');
            resultDiv.innerHTML = '<p class="info">Testing direct API call...</p>';
            
            try {
                const response = await fetch('/api/v1/data-science/statistical-tests?column=snow_water_equivalent_mm');
                const data = await response.json();
                
                resultDiv.innerHTML = `
                    <h4>üìä Direct API Response:</h4>
                    <p class="success"><strong>Status:</strong> ${data.success ? '‚úÖ Success' : '‚ùå Failed'}</p>
                    <p><strong>Data Available:</strong> ${data.results ? '‚úÖ Yes' : '‚ùå No'}</p>
                    <p><strong>Normality Test:</strong> ${data.results?.normality ? '‚úÖ Available' : '‚ùå Missing'}</p>
                    <p><strong>Stationarity Test:</strong> ${data.results?.stationarity ? '‚úÖ Available' : '‚ùå Missing'}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                // Store data for next test
                window.apiData = data;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>‚ùå Direct API Error:</h4>
                    <p class="error">${error.message}</p>
                    <p><strong>Error Type:</strong> ${error.name}</p>
                    <p><strong>Note:</strong> This test runs on port 8080, API is on port 8000</p>
                `;
            }
        }
        
        // Test 2: Main UI Functions (Simulated)
        function testMainUIFunctions() {
            const resultDiv = document.getElementById('main-ui-result');
            const chartContainer = document.getElementById('main-ui-chart');
            
            if (!window.apiData || !window.apiData.success) {
                resultDiv.innerHTML = '<p class="error">‚ùå No API data available. Run Test 1 first.</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">Testing main UI functions...</p>';
            chartContainer.innerHTML = '';
            
            try {
                // Simulate the main UI displayStatisticalChart function
                const results = window.apiData.results;
                
                // Transform API data to expected format (same as main UI)
                const tests = [];
                if (results.normality) {
                    tests.push({
                        test_name: 'Shapiro-Wilk Normality',
                        p_value: results.normality.shapiro_p_value,
                        statistic: results.normality.shapiro_statistic
                    });
                }
                if (results.stationarity) {
                    tests.push({
                        test_name: 'ADF Stationarity',
                        p_value: results.stationarity.p_value,
                        statistic: results.stationarity.adf_statistic
                    });
                }
                
                // Create chart (same as main UI)
                const canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                chartContainer.appendChild(canvas);
                
                const ctx = canvas.getContext('2d');
                const width = chartContainer.offsetWidth;
                const height = chartContainer.offsetHeight;
                
                canvas.width = width;
                canvas.height = height;
                
                // Draw chart
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, width, height);
                
                const names = tests.map(t => t.test_name);
                const pValues = tests.map(t => t.p_value);
                
                if (pValues.length > 0) {
                    const barWidth = width / pValues.length * 0.8;
                    const barSpacing = width / pValues.length * 0.2;
                    const maxPValue = Math.max(...pValues);
                    
                    pValues.forEach((pValue, index) => {
                        const x = index * (barWidth + barSpacing) + barSpacing / 2;
                        const barHeight = (pValue / maxPValue) * height * 0.8;
                        const y = height - barHeight - 20;
                        
                        ctx.fillStyle = '#3498db';
                        ctx.fillRect(x, y, barWidth, barHeight);
                        
                        // Add labels
                        ctx.fillStyle = '#2c3e50';
                        ctx.font = '10px Arial';
                        ctx.fillText(names[index].substring(0, 15), x, height - 5);
                        ctx.fillText(`p=${pValue.toExponential(2)}`, x, height - 20);
                    });
                    
                    // Add title
                    ctx.fillStyle = '#2c3e50';
                    ctx.font = '14px Arial';
                    ctx.fillText('Statistical Tests - P-Values', 10, 20);
                }
                
                resultDiv.innerHTML += `
                    <p class="success">‚úÖ Main UI functions test successful!</p>
                    <p><strong>Tests:</strong> ${tests.length}</p>
                    <p><strong>P-Values:</strong> ${pValues.map(p => p.toExponential(2)).join(', ')}</p>
                    <p><strong>Chart:</strong> Canvas chart generated and displayed</p>
                `;
                
                // Store transformed data for next test
                window.transformedTests = tests;
                
            } catch (error) {
                resultDiv.innerHTML += `
                    <p class="error">‚ùå Main UI functions test failed: ${error.message}</p>
                    <p><strong>Stack:</strong> <pre>${error.stack}</pre></p>
                `;
            }
        }
        
        // Test 3: Full Integration Test
        function testFullIntegration() {
            const resultDiv = document.getElementById('integration-result');
            
            if (!window.transformedTests || window.transformedTests.length === 0) {
                resultDiv.innerHTML = '<p class="error">‚ùå No transformed data available. Run Test 2 first.</p>';
                return;
            }
            
            try {
                const tests = window.transformedTests;
                
                // Calculate metrics (same as main UI)
                const significantTests = tests.filter(t => (t.p_value || 1) < 0.05).length;
                const totalTests = tests.length;
                const avgPValue = tests.reduce((sum, t) => sum + (t.p_value || 1), 0) / totalTests;
                const verySignificant = tests.filter(t => (t.p_value || 1) < 0.01).length;
                const significanceRate = (significantTests / totalTests) * 100;
                
                // Generate interpretation (simplified version)
                let interpretation = '';
                if (significantTests === 0) {
                    interpretation = 'All tests show significant results (p < 0.05)';
                } else if (significantTests === totalTests) {
                    interpretation = 'No tests show significant results';
                } else {
                    interpretation = `${significantTests} out of ${totalTests} tests show significant results`;
                }
                
                resultDiv.innerHTML = `
                    <h4>üìä Full Integration Test Results:</h4>
                    <p><strong>Total Tests:</strong> ${totalTests}</p>
                    <p><strong>Significant Tests:</strong> ${significantTests} (${significanceRate.toFixed(1)}%)</p>
                    <p><strong>Very Significant:</strong> ${verySignificant}</p>
                    <p><strong>Average P-Value:</strong> ${avgPValue.toExponential(2)}</p>
                    <p><strong>Interpretation:</strong> ${interpretation}</p>
                    <p class="success">‚úÖ Full integration test successful!</p>
                    <p class="info"><strong>Note:</strong> This simulates what should happen in the main UI</p>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <h4>‚ùå Full Integration Test Error:</h4>
                    <p class="error">${error.message}</p>
                    <p><strong>Stack:</strong> <pre>${error.stack}</pre></p>
                `;
            }
        }
        
        // Auto-test when page loads
        window.onload = function() {
            console.log('Test page loaded, ready for testing...');
        };
    </script>
</body>
</html>
