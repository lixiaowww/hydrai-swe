# 土壤水分数据获取指南

## 概述

本文档说明如何获取真实的土壤水分观测数据，以解决土壤湿度预测API的422错误问题。

## 🔍 问题分析

### 当前状况
- **API状态**: 土壤湿度预测API返回422错误
- **根本原因**: 数据集中缺少真实的土壤水分观测数据
- **系统要求**: 禁止使用合成数据，必须使用真实观测数据

### 可用数据
当前数据集包含以下特征：
- `snow_depth_mm` - 积雪深度
- `snow_fall_mm` - 降雪量
- `snow_water_equivalent_mm` - 积雪等效水深
- `day_of_year`, `month`, `year` - 时间特征
- `streamflow_m3s` - 径流量

### 缺失数据
- `soil_moisture` - 土壤水分含量（必需）

## 🛠️ 解决方案

### 方案1: 获取真实土壤水分数据（推荐）

#### 1.1 曼尼托巴省农业气象网络
**数据源**: 曼尼托巴省农业气象网络
**访问方式**: FTP / API
**数据内容**: 土壤温度、湿度、蒸发量
**更新频率**: 每小时
**联系方式**: 曼尼托巴省农业部门

**获取步骤**:
1. 联系曼尼托巴省农业部门
2. 申请农业气象网络访问权限
3. 获取土壤水分传感器数据
4. 数据格式化和集成

#### 1.2 加拿大土壤数据库 (CanSIS)
**数据源**: 加拿大土壤数据库
**访问方式**: REST API
**数据内容**: 土壤类型、质地、pH值、有机质
**更新频率**: 每年
**API端点**: https://sis.agr.gc.ca/cansis/

**获取步骤**:
```python
import requests

# 获取曼尼托巴省土壤数据
url = "https://sis.agr.gc.ca/cansis/api/soils"
params = {
    "province": "MB",
    "format": "json"
}
response = requests.get(url, params=params)
soil_data = response.json()
```

#### 1.3 合作伙伴数据源
**数据源**: 农业合作社、研究机构
**访问方式**: 合作伙伴API
**数据内容**: 局部土壤水分观测
**更新频率**: 实时/每日

### 方案2: 数据集成和预处理

#### 2.1 数据格式要求
土壤水分数据应包含以下字段：
```csv
date,soil_moisture,soil_temperature,soil_type,location
2024-01-01,25.5,2.3,loam,winnipeg_metro
2024-01-02,26.1,2.1,loam,winnipeg_metro
...
```

#### 2.2 数据质量要求
- **完整性**: 缺失率 < 20%
- **准确性**: 数值在合理范围内 (0-100%)
- **一致性**: 时间序列连续
- **空间覆盖**: 覆盖目标区域

#### 2.3 数据预处理脚本
```python
def prepare_soil_moisture_data(raw_data_path, output_path):
    """
    预处理土壤水分数据
    
    Args:
        raw_data_path: 原始数据文件路径
        output_path: 输出文件路径
    """
    # 读取原始数据
    df = pd.read_csv(raw_data_path)
    
    # 数据清理
    df = df.dropna(subset=['soil_moisture'])
    
    # 数据验证
    df = df[df['soil_moisture'].between(0, 100)]
    
    # 时间序列对齐
    df['date'] = pd.to_datetime(df['date'])
    df = df.sort_values('date')
    
    # 保存处理后的数据
    df.to_csv(output_path, index=False)
    
    return df
```

### 方案3: 临时解决方案

#### 3.1 API错误处理优化
已实现的改进：
- 返回友好的错误信息而不是422错误
- 提供详细的数据缺失说明
- 建议获取真实数据的方法

#### 3.2 前端用户体验优化
- 显示警告信息而不是错误
- 提供数据获取建议
- 显示可用的数据特征

## 📊 数据获取优先级

### 高优先级
1. **曼尼托巴省农业气象网络** - 本地数据，实时更新
2. **加拿大土壤数据库** - 官方数据源，质量可靠

### 中优先级
3. **合作伙伴数据** - 专业数据，但可能有限制
4. **研究机构数据** - 学术数据，可能有时效性

### 低优先级
5. **公开数据集** - 可能不完全匹配需求
6. **历史数据** - 可能过时

## 🔧 实施步骤

### 第一步: 数据源评估
1. 评估各数据源的可用性
2. 检查数据质量和覆盖范围
3. 确定数据获取成本和时间

### 第二步: 数据获取
1. 申请必要的访问权限
2. 下载和验证数据
3. 检查数据格式和完整性

### 第三步: 数据集成
1. 数据预处理和清理
2. 与现有数据集合并
3. 验证数据一致性

### 第四步: API测试
1. 测试土壤湿度预测功能
2. 验证预测结果质量
3. 性能测试和优化

## 📋 检查清单

### 数据获取前
- [ ] 确定数据需求（时间范围、空间覆盖、精度要求）
- [ ] 评估数据源可用性和成本
- [ ] 申请必要的访问权限
- [ ] 准备数据存储和处理环境

### 数据获取中
- [ ] 下载数据文件
- [ ] 验证文件完整性
- [ ] 检查数据格式
- [ ] 初步数据质量评估

### 数据获取后
- [ ] 数据预处理和清理
- [ ] 与现有数据集集成
- [ ] 数据质量验证
- [ ] API功能测试

## 🚨 注意事项

### 数据质量
- 确保数据来源可靠
- 验证数据准确性
- 检查数据完整性

### 法律合规
- 遵守数据使用协议
- 注意数据隐私保护
- 确保数据使用权限

### 技术实现
- 数据格式标准化
- 错误处理机制
- 性能优化

## 📞 联系信息

### 曼尼托巴省农业部门
- **网站**: https://www.gov.mb.ca/agriculture/
- **电话**: +1-204-945-0000
- **邮箱**: agriculture@gov.mb.ca

### 加拿大土壤数据库
- **网站**: https://sis.agr.gc.ca/cansis/
- **API文档**: https://sis.agr.gc.ca/cansis/api/
- **技术支持**: cansissupport@agr.gc.ca

### 项目团队
- **项目负责人**: Sean Li
- **邮箱**: lixiaowww@gmail.com
- **项目仓库**: https://github.com/lixiaowww/hydrai-swe

---

**最后更新**: 2025-08-25  
**状态**: 需要获取真实土壤水分数据  
**优先级**: 高
