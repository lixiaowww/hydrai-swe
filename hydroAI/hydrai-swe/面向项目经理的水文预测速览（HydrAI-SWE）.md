## 

### 核心概念
- **SWE（Snow Water Equivalent）/积雪水当量**: 把积雪换算成等体积液态水的厚度，单位 mm。是融雪型径流的关键输入。
- **融雪-径流过程**: 积雪在温度/辐射/降水作用下融化，产水沿地表与地下汇集至河道形成流量（m³/s）。
- **流量（Runoff/Discharge）**: 河道单位时间过水量，防洪、调度、风险评估的核心指标。

### 数据与来源（本项目已适配）
- **ECCC（加拿大环境与气候变化部）**
  - 每日气候观测 CSV（Manitoba 目录），含积雪深度、降雪等。
  - GRIB2 天气格点（温度、降水）可作未来强迫数据。
- **HYDAT（加拿大水文数据库）**
  - 河道站点流量/水位。用于监督学习（目标变量）。
- **NASA MODIS/VIIRS（雪盖遥感）**
  - 雪盖面积/雪深时空分布，弥补地面站点稀疏。
- 关键注意：坐标与时间对齐、单位转换（cm→mm），以及区域过滤（红河流域）可显著提升信噪比。

### 预测方法谱系
- **经验/概念模型**
  - 度日融雪（Degree-Day）：用温度累计估计融雪量；简洁可解释。
- **物理模型**
  - 能量平衡/分布式水文（资料需求大、参数敏感、算力高）。
- **数据驱动模型（本项目采用）**
  - LSTM/GRU/TCN/Transformer：直接从历史输入-输出学习映射，易扩展多源数据。
  - 需求：高质量对齐数据、谨慎防止数据泄漏、稳定评估框架。

### 评估指标（回归为主）
- **RMSE/MAE**: 误差越小越好，RMSE对大偏差敏感，MAE鲁棒。
- **R²**: 解释度 \( 1 - \frac{\sum (y-\hat{y})^2}{\sum (y-\bar{y})^2} \)。
- **NSE（Nash–Sutcliffe Efficiency）**: 与 R²形式相似，水文学常用。0~1较好，<0 表示不如“用均值”的基线。
- 分类指标（准确率/精确率/召回率/F1）：用于“事件检测”（如洪峰超阈），需先将连续流量二值化；阈值应依据 Manitoba 政府/流域管理机构标准。

### 交叉验证与防泄漏
- **时间序列前向链（Forward-Chaining）**: 用过去训练→未来验证/测试；绝不打乱时间顺序。
- **空间泄漏**: 多站点/多流域时，需留出法（例如按流域分组）避免相邻站点“信息泄漏”。
- **派生特征泄漏**: 严禁用未来窗口计算当前特征（移动平均等必须仅用历史）。

### 预测类型与不确定性
- **Nowcast（近实时预测）**: 基于最新观测推断短期未来。
- **Forecast（前瞻预测）**: 需要未来强迫（天气预报/情景）。
- **Scenario（情景）**: 历史相似年/统计分位构造情景，不等同于预报；需明确披露来源与不确定性。
- 不确定性表达：多成员集成、置信区间、情景带。

### Manitoba 本地化要点
- 区域配置：红河流域边界、优先站点（05OC001 Emerson、05OC011 Winnipeg、05OC012 Lockport）。
- 数据口径：ECCC CSV 字段名（Total Snow、Snow on Grnd），单位换算与坐标过滤（bounding box）。
- 事件阈值：洪水/警戒阈值需查阅 Manitoba 相关部门发布的站点规范或水文年鉴，作为分类指标的二值化标准。
- 合规与真实性：明确区分“情景”与“预报”；标注数据时间戳、来源、版本。

### 本项目实现映射（你需要知道的）
- 数据通道
  - `src/data/download_eccc_manitoba.py` / `download_recent_eccc.py`: 抓取 ECCC CSV。
  - `src/data/etl.py`: 汇总 NASA/ECCC/HYDAT 到 `data/processed/`。
  - `src/neuralhydrology/prepare_data.py`: 生成训练 CSV 与评测集（仅重叠日期、无合成流量）；支持区域过滤。
- 训练与评估
  - `src/models/train.py` / `run_full_training.py`: 按配置训练 NeuralHydrology。
  - `src/models/metrics.py`: NSE/RMSE/MAE/R²。
  - `src/models/cv_evaluate.py` / `cv_generate_configs.py` / `cv_collect_results.py`: 前向链交叉验证（基线、配置生成、结果汇总）。
- 推理与服务
  - `src/models/predict_service.py`: 加载最近 `runs/` 做真实推理（缺失则稳定回退）。
  - `src/api/routers/swe.py`: `/api/v1/runoff-forecast`（支持 nowcast/scenario）。
  - `templates/index.html`: 最小 UI，曲线、汇总、CSV 下载、情景对比。

### 质量与风险控制
- 数据质量：日期连续性、缺测/异常、单位一致、空间过滤。
- 评估可信度：与强基线（如 7日移动平均）对比；NSE/RMSE 的季节分解；多折稳定性。
- 变更管理：每次模型/特征更新，固定评测集与交叉验证流程复跑；API 回归测试保持通过。

### 演示话术（面向客户）
- 我们引入 ECCC/HYDAT/NASA 多源数据，聚焦红河流域；用数据驱动模型（LSTM）和强基线（7日移动平均）做对比评估，采用时间前向交叉验证严格防止数据泄漏。
- Nowcast 依赖最新观测；Forecast 需气象预报或情景。界面支持站点、模式、情景年份选择与结果可视化、下载。
- 阈值与事件定义遵循 Manitoba 部门口径；我们会按官方标准计算事件型指标（精确率/召回率等），并提供不确定性表达。

### 快速问答
- Q: NSE 为负代表什么？  
  A: 模型比“用长期均值”更差；需要提高特征/模型或改善数据匹配。
- Q: 为什么要区域过滤？  
  A: 全省平均会稀释站点信号；按流域/邻近站点聚合可显著提升有效性。
- Q: 情景和预报的区别？  
  A: 情景是历史构造的假设路径，预报需要未来强迫（气象预报）。二者不能混称。

如需，我可以把以上内容整理为可交付的 README 附录或客户演示简报（含图示与流程图）。