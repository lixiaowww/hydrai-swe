<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸš¨ å…¨é¢å‰ç«¯æµ‹è¯•</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
        .test-section { margin: 20px 0; padding: 20px; border: 2px solid #007bff; border-radius: 8px; background: white; }
        .chart-container { height: 300px; margin: 15px 0; border: 1px solid #ddd; }
        .interpretation { background: #e8f5e8; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; overflow-x: auto; max-height: 200px; }
        .status { padding: 5px 10px; border-radius: 3px; margin: 5px; display: inline-block; }
        .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <h1>ğŸš¨ çœ‹é—¨ç‹—+é«˜æ‰‹ å…¨é¢å‰ç«¯è¯Šæ–­</h1>
    
    <div class="test-section">
        <h2>1. APIè¿æ¥æµ‹è¯•</h2>
        <div id="api-status"></div>
    </div>

    <div class="test-section">
        <h2>2. èšç±»åˆ†ææµ‹è¯•</h2>
        <div id="clustering-status"></div>
        <div id="clustering-chart" class="chart-container"></div>
        <div id="clustering-interpretation" class="interpretation"></div>
    </div>

    <div class="test-section">
        <h2>3. ç»Ÿè®¡æ£€éªŒæµ‹è¯•</h2>
        <div id="statistical-status"></div>
        <div id="statistical-chart" class="chart-container"></div>
        <div id="statistical-interpretation" class="interpretation"></div>
    </div>

    <div class="test-section">
        <h2>4. å› å­å‘ç°æµ‹è¯•</h2>
        <div id="factors-status"></div>
        <div id="factors-chart" class="chart-container"></div>
        <div id="factors-interpretation" class="interpretation"></div>
    </div>

    <div class="test-section">
        <h2>5. å¼‚å¸¸æ£€æµ‹æµ‹è¯•</h2>
        <div id="anomaly-status"></div>
        <div id="anomaly-chart" class="chart-container"></div>
        <div id="anomaly-interpretation" class="interpretation"></div>
    </div>

    <script>
        function setStatus(elementId, success, message) {
            const element = document.getElementById(elementId);
            const statusClass = success ? 'success' : 'error';
            element.innerHTML = `<div class="status ${statusClass}">${success ? 'âœ…' : 'âŒ'} ${message}</div>`;
        }

        async function testAPI(url, name) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                return { success: true, data };
            } catch (error) {
                return { success: false, error: error.message };
            }
        }

        async function testClustering() {
            const result = await testAPI('/api/v1/data-science/clustering', 'èšç±»åˆ†æ');
            
            if (result.success) {
                const results = result.data.results;
                setStatus('clustering-status', true, `èšç±»APIæˆåŠŸ - K-means: ${results.kmeans.n_clusters}ä¸ªèšç±», è½®å»“åˆ†æ•°: ${results.kmeans.silhouette_score.toFixed(3)}`);
                
                // æ¸²æŸ“å›¾è¡¨
                const labels = results.kmeans.labels;
                const counts = {};
                labels.forEach(l => { const k = String(l); counts[k] = (counts[k]||0)+1; });
                const keys = Object.keys(counts).sort((a,b)=> parseInt(a)-parseInt(b));
                const vals = keys.map(k=> counts[k]);
                
                Plotly.newPlot('clustering-chart', [{
                    type:'bar', x:keys, y:vals, marker:{color:'#2ecc71'}
                }], {
                    title:'K-meansèšç±»å¤§å°åˆ†å¸ƒ', height:300, margin:{l:40,r:10,t:50,b:40}
                }, {displaylogo:false, responsive:false, staticPlot:false});
                
                // æ˜¾ç¤ºè§£è¯»
                if (results.interpretation) {
                    const interp = results.interpretation;
                    let html = '<h4>ğŸŒ èšç±»åˆ†æè§£è¯»</h4>';
                    if (interp.summary) html += `<p><strong>æ‘˜è¦:</strong> ${interp.summary}</p>`;
                    if (interp.key_insights) {
                        html += '<p><strong>å…³é”®æ´å¯Ÿ:</strong></p><ul>';
                        interp.key_insights.forEach(insight => html += `<li>${insight}</li>`);
                        html += '</ul>';
                    }
                    document.getElementById('clustering-interpretation').innerHTML = html;
                } else {
                    document.getElementById('clustering-interpretation').innerHTML = '<div class="error">âŒ è§£è¯»å†…å®¹ç¼ºå¤±</div>';
                }
            } else {
                setStatus('clustering-status', false, `èšç±»APIå¤±è´¥: ${result.error}`);
            }
        }

        async function testStatistical() {
            const result = await testAPI('/api/v1/data-science/statistical-tests?column=snow_water_equivalent_mm', 'ç»Ÿè®¡æ£€éªŒ');
            
            if (result.success) {
                const results = result.data.results;
                setStatus('statistical-status', true, `ç»Ÿè®¡æ£€éªŒAPIæˆåŠŸ - æ£€éªŒæ•°é‡: ${results.test_names.length}`);
                
                // æ¸²æŸ“å›¾è¡¨
                if (results.test_names.length > 0) {
                    const traces = [{
                        type:'bar', x:results.test_names, y:results.original_p, 
                        name:'Original p', marker:{color:'#3498db'}
                    }];
                    
                    Plotly.newPlot('statistical-chart', traces, {
                        title:'ç»Ÿè®¡å‡è®¾æ£€éªŒ På€¼', height:300, 
                        yaxis:{type:'log', title:'På€¼ (å¯¹æ•°å°ºåº¦)'},
                        margin:{l:40,r:10,t:50,b:40}
                    }, {displaylogo:false, responsive:false, staticPlot:false});
                    
                    document.getElementById('statistical-interpretation').innerHTML = 
                        `<h4>ğŸ“Š ç»Ÿè®¡æ£€éªŒè§£è¯»</h4><p>${results.interpretation || 'è§£è¯»å†…å®¹ç¼ºå¤±'}</p>`;
                } else {
                    document.getElementById('statistical-chart').innerHTML = '<div class="error">âŒ æ— ç»Ÿè®¡æ£€éªŒæ•°æ®</div>';
                }
            } else {
                setStatus('statistical-status', false, `ç»Ÿè®¡æ£€éªŒAPIå¤±è´¥: ${result.error}`);
            }
        }

        async function testFactors() {
            const result = await testAPI('/api/v1/data-science/factor-discovery?target=snow_water_equivalent_mm&top_k=10', 'å› å­å‘ç°');
            
            if (result.success) {
                const results = result.data.results;
                setStatus('factors-status', true, `å› å­å‘ç°APIæˆåŠŸ - å› å­æ•°é‡: ${results.high_predictive.length}`);
                
                // æ¸²æŸ“å›¾è¡¨
                if (results.high_predictive.length > 0) {
                    const names = results.high_predictive.map(item => item.factor);
                    const scores = results.high_predictive.map(item => item.score);
                    
                    Plotly.newPlot('factors-chart', [{
                        type:'bar', x:scores, y:names, orientation:'h', marker:{color:'#f39c12'}
                    }], {
                        title:'é‡è¦å› å­å‘ç°', height:300, 
                        margin:{l:120,r:10,t:50,b:40}
                    }, {displaylogo:false, responsive:false, staticPlot:false});
                    
                    document.getElementById('factors-interpretation').innerHTML = 
                        `<h4>ğŸ” å› å­å‘ç°è§£è¯»</h4><p>${results.interpretation || 'è§£è¯»å†…å®¹ç¼ºå¤±'}</p>`;
                } else {
                    document.getElementById('factors-chart').innerHTML = '<div class="error">âŒ æ— å› å­æ•°æ®</div>';
                }
            } else {
                setStatus('factors-status', false, `å› å­å‘ç°APIå¤±è´¥: ${result.error}`);
            }
        }

        async function testAnomaly() {
            const result = await testAPI('/api/v1/data-science/anomaly-detection?column=snow_water_equivalent_mm', 'å¼‚å¸¸æ£€æµ‹');
            
            if (result.success) {
                const results = result.data.results;
                const anomalyCount = results.ensemble.ensemble_anomalies.filter(x => x).length;
                setStatus('anomaly-status', true, `å¼‚å¸¸æ£€æµ‹APIæˆåŠŸ - å¼‚å¸¸ç‚¹æ•°é‡: ${anomalyCount}`);
                
                // æ¸²æŸ“å›¾è¡¨
                if (results.ensemble.ensemble_scores) {
                    const scores = results.ensemble.ensemble_scores;
                    const anomalies = results.ensemble.ensemble_anomalies;
                    const x = Array.from({length: scores.length}, (_, i) => i);
                    
                    const traces = [
                        {x, y: scores, type:'scatter', mode:'lines', name:'å¼‚å¸¸åˆ†æ•°', line:{color:'#34495e'}},
                        {x, y: scores.map((v,i)=> anomalies[i] ? v : null), type:'scatter', mode:'markers', name:'å¼‚å¸¸ç‚¹', marker:{color:'#e74c3c', size:4}}
                    ];
                    
                    Plotly.newPlot('anomaly-chart', traces, {
                        title:'å¼‚å¸¸æ£€æµ‹ç»“æœ', height:300, margin:{l:40,r:10,t:50,b:40}
                    }, {displaylogo:false, responsive:false, staticPlot:false});
                    
                    document.getElementById('anomaly-interpretation').innerHTML = 
                        `<h4>ğŸš¨ å¼‚å¸¸æ£€æµ‹è§£è¯»</h4><p>${results.interpretation || 'è§£è¯»å†…å®¹ç¼ºå¤±'}</p>`;
                } else {
                    document.getElementById('anomaly-chart').innerHTML = '<div class="error">âŒ æ— å¼‚å¸¸æ£€æµ‹åˆ†æ•°æ•°æ®</div>';
                }
            } else {
                setStatus('anomaly-status', false, `å¼‚å¸¸æ£€æµ‹APIå¤±è´¥: ${result.error}`);
            }
        }

        async function runAllTests() {
            // APIè¿æ¥æµ‹è¯•
            const healthCheck = await testAPI('/health', 'Health Check');
            setStatus('api-status', healthCheck.success, healthCheck.success ? 'APIæœåŠ¡å™¨è¿æ¥æ­£å¸¸' : `APIè¿æ¥å¤±è´¥: ${healthCheck.error}`);
            
            if (healthCheck.success) {
                // å¹¶è¡Œè¿è¡Œæ‰€æœ‰æµ‹è¯•
                await Promise.all([
                    testClustering(),
                    testStatistical(), 
                    testFactors(),
                    testAnomaly()
                ]);
            }
        }

        // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runAllTests);
    </script>
</body>
</html>



