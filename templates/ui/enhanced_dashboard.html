<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HydrAI-SWE Enhanced Analysis Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .nav-links {
            text-align: center;
            margin-bottom: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 8px;
            padding: 8px 16px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            display: inline-block;
            font-size: 0.9rem;
        }

        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-links a.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: bold;
        }

        .data-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #155724;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        .dashboard .card:first-child {
            grid-column: 1 / -1;
            max-width: 100%;
        }

        /* ‰ºòÂåñ‰ø°ÊÅØÂØÜÂ∫¶ */
        .compact-view {
            font-size: 0.9rem;
        }

        .compact-view .metric {
            padding: 8px;
            margin-bottom: 8px;
        }

        .compact-view .analysis-content {
            font-size: 0.85rem;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-bottom: 20px;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e0e0e0;
        }

        .card-icon {
            font-size: 1.5rem;
            margin-right: 12px;
            color: #667eea;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .expand-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .expand-btn:hover {
            background: #f0f0f0;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .metric:hover {
            background: #e9ecef;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
            flex: 1;
        }

        .metric-value {
            font-weight: 700;
            color: #333;
            font-size: 1.1rem;
            text-align: right;
        }

        .analysis-section {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            clear: both;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            /* ÈªòËÆ§ÊòæÁ§∫Ôºå‰ΩÜÂèØ‰ª•ÊäòÂè† */
            display: block;
        }

        .analysis-section.collapsed {
            display: none;
        }

        .analysis-section.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .analysis-title {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
        }

        .analysis-title:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .analysis-title i {
            margin-right: 8px;
            color: #667eea;
            font-size: 0.9rem;
        }

        .analysis-content {
            line-height: 1.5;
            color: #555;
            font-size: 0.9rem;
            margin-bottom: 12px;
        }

        .analysis-content:last-child {
            margin-bottom: 0;
        }

        .insight {
            background: #e8f4f8;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .insight-title {
            font-weight: 600;
            color: #0c5460;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .insight-content {
            color: #0c5460;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .prediction {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }

        .prediction-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }

        .prediction-content {
            color: #856404;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-top: 15px;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background: #f8d7da;
            border-radius: 8px;
            margin: 10px 0;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: #28a745;
        }

        .status-warning {
            background-color: #ffc107;
        }

        .status-error {
            background-color: #dc3545;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
            margin: 10px 0;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .last-update {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-top: 20px;
        }

        .data-age-warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            color: #721c24;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-water"></i> HydrAI-SWE</h1>
            <p>Intelligent Snow Water Equivalent Prediction System</p>
        </div>

        <div class="nav-links">
            <a href="/home"><i class="fas fa-home"></i> Home</a>
            <a href="/ui" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/model"><i class="fas fa-robot"></i> Training</a>
            <a href="/analysis"><i class="fas fa-chart-line"></i> Analysis</a>
            <a href="/about"><i class="fas fa-info-circle"></i> About</a>
        </div>

        <div class="data-success">
            <i class="fas fa-check-circle"></i>
            <strong>Real-Time Data Status:</strong> System is powered by live official data sources including
            Manitoba Flood Alerts (<span id="status-mb-flood" class="dynamic-date">loading...</span>),
            RDPS Precipitation Forecast (<span id="status-rdps" class="dynamic-date">loading...</span>),
            Winnipeg River Levels (<span id="status-river" class="dynamic-date">loading...</span>),
            and Winnipeg Water Quality (<span id="status-water" class="dynamic-date">loading...</span>).
            All data is sourced from official government agencies.
        </div>

        <div class="dashboard">
            <!-- SWE Historical Card (Real Data with Time Filters) -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-chart-line card-icon"></i>
                    <div class="card-title">SWE Historical (Real Data)</div>
                </div>
                <div>
                    <div style="display:flex; flex-wrap: wrap; gap: 10px; align-items: center;">
                        <label>Window
                            <select id="swe-window" style="margin-left:6px;">
                                <option value="all">All</option>
                                <option value="24h">24h</option>
                                <option value="7d">7d</option>
                                <option value="30d" selected>30d</option>
                                <option value="custom">custom</option>
                            </select>
                        </label>
                        <label>Start
                            <input type="date" id="swe-start">
                        </label>
                        <label>End
                            <input type="date" id="swe-end">
                        </label>
                        <label>Page Size
                            <input type="number" id="swe-page-size" min="1" max="2000" value="2000" style="width:90px;">
                        </label>
                        <button class="refresh-btn" id="swe-apply-btn"><i class="fas fa-filter"></i> Apply</button>
                        <button class="refresh-btn" id="swe-download-btn"><i class="fas fa-download"></i> Download
                            CSV</button>
                        <button class="refresh-btn" id="swe-toggle-anomaly"><i class="fas fa-wave-square"></i> Toggle
                            Anomaly</button>
                        <span id="swe-freshness" class="last-update" style="margin-left:auto;">‚Äì</span>
                    </div>
                    <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
                        <button class="refresh-btn" id="swe-prev-page">Prev</button>
                        <span id="swe-page-info" style="font-size:0.95rem;color:#555;">page 1/1</span>
                        <button class="refresh-btn" id="swe-next-page">Next</button>
                    </div>
                </div>
                <div id="swe-historical-content" class="chart-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading SWE historical...</p>
                    </div>
                </div>
                <div id="swe-anomaly-container" class="chart-container" style="display:none;"></div>
                <div class="analysis-section expanded" id="swe-analysis-section">
                    <div class="analysis-title" onclick="toggleAnalysis('swe-analysis-section', event)">
                        <i class="fas fa-user-graduate"></i> Expert Interpretation
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="swe-interpretation"></div>
                    <div class="analysis-title" onclick="toggleAnalysis('swe-analysis-section', event)"
                        style="margin-top:8px;">
                        <i class="fas fa-shield-alt"></i> Provenance
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="swe-provenance"></div>
                    <div class="analysis-title" onclick="toggleAnalysis('swe-analysis-section', event)"
                        style="margin-top:8px;">
                        <i class="fas fa-sigma"></i> Summary
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="swe-summary"></div>
                </div>
            </div>

            <!-- Flood Prediction Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-exclamation-triangle card-icon"></i>
                    <div class="card-title">Flood Risk Prediction</div>
                </div>
                <div id="flood-prediction-content" class="chart-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading flood prediction data...</p>
                    </div>
                </div>
                <div class="analysis-section expanded" id="flood-prediction-analysis-section">
                    <div class="analysis-title" onclick="toggleAnalysis('flood-prediction-analysis-section', event)">
                        <i class="fas fa-user-graduate"></i> Expert Interpretation
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="flood-prediction-interpretation"></div>
                    <div class="analysis-title" onclick="toggleAnalysis('flood-prediction-analysis-section', event)"
                        style="margin-top:8px;">
                        <i class="fas fa-shield-alt"></i> Provenance
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="flood-prediction-provenance"></div>
                </div>
            </div>

            <!-- Water Quality Analysis Card -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-tint card-icon"></i>
                    <div class="card-title">Water Quality Analysis</div>
                </div>
                <div id="water-quality-content" class="chart-container">
                    <div class="loading">
                        <i class="fas fa-spinner"></i>
                        <p>Loading water quality data...</p>
                    </div>
                </div>
                <div class="analysis-section expanded" id="water-quality-analysis-section">
                    <div class="analysis-title" onclick="toggleAnalysis('water-quality-analysis-section', event)">
                        <i class="fas fa-user-graduate"></i> Expert Interpretation
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="water-quality-interpretation"></div>
                    <div class="analysis-title" onclick="toggleAnalysis('water-quality-analysis-section', event)"
                        style="margin-top:8px;">
                        <i class="fas fa-shield-alt"></i> Provenance
                        <i class="fas fa-chevron-up" style="margin-left: auto; font-size: 0.8rem;"></i>
                    </div>
                    <div class="analysis-content" id="water-quality-provenance"></div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <button class="refresh-btn" onclick="refreshAllData()">
                <i class="fas fa-sync-alt"></i> Refresh All Data & Analysis
            </button>
            <div class="last-update" id="last-update">
                Last updated: Never
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        // Automatically detect API base URL (production or local development)
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://127.0.0.1:8001/api'
            : '/api';
        const CACHE_VERSION = 'v2.0.8'; // Force cache refresh - Enhanced analysis depth
        let SWE_STATE = { page: 1, total_pages: 1 };

        // Global error handler
        window.addEventListener('error', function (e) {
            console.error('Global error:', e);
        });

        // API request function
        async function apiRequest(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`API request failed for ${endpoint}:`, error);
                throw error;
            }
        }

        // Toggle analysis sections (Improved: supports collapse/expand)
        function toggleAnalysis(sectionId, event) {
            // If event exists, prevent default behavior
            if (event) {
                event.stopPropagation();
            }

            const section = document.getElementById(sectionId);
            if (!section) {
                console.warn(`Analysis section '${sectionId}' not found`);
                return;
            }

            // Toggle expand/collapse state
            const isExpanded = section.classList.contains('expanded');
            if (isExpanded) {
                section.classList.remove('expanded');
                section.classList.add('collapsed');
            } else {
                section.classList.remove('collapsed');
                section.classList.add('expanded');
            }

            // Update all chevron icons (all titles within the same section)
            const titles = section.querySelectorAll('.analysis-title');
            titles.forEach(title => {
                const chevron = title.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (chevron) {
                    if (isExpanded) {
                        chevron.classList.remove('fa-chevron-up');
                        chevron.classList.add('fa-chevron-down');
                    } else {
                        chevron.classList.remove('fa-chevron-down');
                        chevron.classList.add('fa-chevron-up');
                    }
                }
            });

            // Compatibility with old code: find expand button
            const btn = section.previousElementSibling?.querySelector('.expand-btn i');
            if (btn) {
                if (isExpanded) {
                    btn.className = 'fas fa-chevron-down';
                } else {
                    btn.className = 'fas fa-chevron-up';
                }
            }
        }

        // SWE Historical loader
        let sweChart = null;
        async function loadSWEHistorical() {
            const windowSel = document.getElementById('swe-window');
            const startEl = document.getElementById('swe-start');
            const endEl = document.getElementById('swe-end');
            const pageSizeEl = document.getElementById('swe-page-size');
            const container = document.getElementById('swe-historical-content');
            const pageInfo = document.getElementById('swe-page-info');
            const freshness = document.getElementById('swe-freshness');
            const params = new URLSearchParams();
            const windowVal = windowSel.value;

            // Update SWE_STATE status
            SWE_STATE.window = windowVal;
            SWE_STATE.start = startEl.value;
            SWE_STATE.end = endEl.value;

            params.set('window', windowVal);
            params.set('page', SWE_STATE.page.toString());
            params.set('page_size', pageSizeEl.value);
            params.set('data_type', 'daily');
            params.set('region', 'manitoba');

            // Smartly select data source based on time range
            if (windowVal === 'all') {
                const startDate = startEl.value ? new Date(startEl.value) : null;
                const endDate = endEl.value ? new Date(endEl.value) : null;

                if (startDate && endDate) {
                    // User specified date range, select appropriate data source based on range
                    if (startDate.getFullYear() < 2025) {
                        // Data before 2025, prioritize historical data sources
                        params.set('source_order', 'manitoba_daily,manitoba_monthly,swe_validation,realtime');
                    } else if (startDate.getFullYear() >= 2025 && endDate.getFullYear() >= 2025) {
                        // Data from 2025 onwards, prioritize real-time data sources
                        params.set('source_order', 'realtime,manitoba_daily,manitoba_monthly,swe_validation');
                    } else {
                        // Cross-year data, use mixed data sources
                        params.set('source_order', 'manitoba_daily,realtime,manitoba_monthly,swe_validation');
                    }
                } else {
                    // User did not specify date range, default to showing last month
                    windowVal = '30d';
                    params.set('window', '30d');
                    params.set('source_order', 'realtime,manitoba_daily,manitoba_monthly,swe_validation');
                }
            } else {
                // Other window types (7d, 30d, etc.), use default order
                params.set('source_order', 'realtime,manitoba_daily,manitoba_monthly,swe_validation');
            }

            if (windowVal === 'custom') {
                if (!startEl.value || !endEl.value) {
                    container.innerHTML = '<div class="error">Select start and end for custom window</div>';
                    return;
                }
                params.set('start_date', startEl.value);
                params.set('end_date', endEl.value);
            } else if (windowVal === 'all' && startEl.value && endEl.value) {
                // If "All" is selected but user specified date range, use custom range
                console.log(`Using custom date range: ${startEl.value} to ${endEl.value}`);
                params.set('start_date', startEl.value);
                params.set('end_date', endEl.value);
            }
            try {
                // Prioritize trying to get real-time data
                let data;
                try {
                    // Build real-time data API request parameters
                    let realtimeParams = '';
                    if (windowVal === 'custom' && startEl.value && endEl.value) {
                        realtimeParams = `?start_date=${startEl.value}&end_date=${endEl.value}`;
                    } else if (windowVal === 'all' && startEl.value && endEl.value) {
                        realtimeParams = `?start_date=${startEl.value}&end_date=${endEl.value}`;
                    }

                    data = await apiRequest(`/swe/realtime${realtimeParams}`);
                    // Convert real-time data format to match historical data format
                    const realtimeData = data;
                    // Deduplicate and sort data
                    const uniqueData = {};
                    realtimeData.data.forEach(item => {
                        const date = item.timestamp.split('T')[0];
                        if (!uniqueData[date] || item.swe_mm > uniqueData[date].swe_mm) {
                            uniqueData[date] = item;
                        }
                    });
                    const sortedData = Object.values(uniqueData).sort((a, b) =>
                        new Date(a.timestamp) - new Date(b.timestamp)
                    );

                    data = {
                        dates: sortedData.map(item => item.timestamp.split('T')[0]),
                        swe_values: sortedData.map(item => item.swe_mm),
                        summary: {
                            count: sortedData.length,
                            mean_mm: realtimeData.summary.mean_swe_mm,
                            std_mm: realtimeData.summary.std_swe_mm,
                            min_mm: realtimeData.summary.min_swe_mm,
                            max_mm: realtimeData.summary.max_swe_mm,
                            last_value_mm: realtimeData.summary.latest_swe_mm,
                            last_date: realtimeData.summary.latest_timestamp.split('T')[0]
                        },
                        interpretation: {
                            signal: realtimeData.summary.latest_swe_mm > realtimeData.summary.mean_swe_mm ? "increasing" : "decreasing",
                            percent_vs_historical: ((realtimeData.summary.latest_swe_mm - realtimeData.summary.mean_swe_mm) / realtimeData.summary.mean_swe_mm * 100).toFixed(1)
                        },
                        provenance: {
                            source: "realtime_2025",
                            source_path: "Real-time SWE data from multiple sources",
                            updated_at: realtimeData.last_updated,
                            lineage_id: "realtime_" + Date.now()
                        },
                        page_info: {
                            page: 1,
                            total_pages: 1,
                            total_count: realtimeData.data.length
                        }
                    };
                } catch (realtimeError) {
                    // If real-time data fails, fallback to historical data
                    console.log("Realtime data not available, falling back to historical data");
                    data = await apiRequest(`/swe/historical?${params.toString()}`);
                }

                // If real-time data is empty (date range exceeds real-time data range), fallback to historical data
                if (data && data.data && data.data.length === 0) {
                    console.log("No realtime data for date range, falling back to historical data");
                    data = await apiRequest(`/swe/historical?${params.toString()}`);
                }

                // If real-time data exists but date range doesn't match, also fallback to historical data
                if (data && data.data && data.data.length > 0) {
                    const firstDate = new Date(data.data[0].timestamp);
                    const lastDate = new Date(data.data[data.data.length - 1].timestamp);
                    const requestedStart = startEl.value ? new Date(startEl.value) : null;
                    const requestedEnd = endEl.value ? new Date(endEl.value) : null;

                    if (requestedStart && requestedEnd) {
                        if (firstDate > requestedEnd || lastDate < requestedStart) {
                            console.log("Realtime data date range doesn't match request, falling back to historical data");
                            data = await apiRequest(`/swe/historical?${params.toString()}`);
                        }
                    }
                }
                SWE_STATE.last_payload = data; // cache for download/anomaly
                // update page state
                SWE_STATE.total_pages = data.page_info.total_pages;
                pageInfo.textContent = `page ${data.page_info.page}/${data.page_info.total_pages} ‚Ä¢ ${data.page_info.total_count} days`;
                freshness.textContent = `Provenance updated: ${data.provenance?.updated_at || 'unknown'}`;

                // Update date inputs to show actual range of current data
                updateDateInputsFromData(data);

                // build chart
                container.innerHTML = '<canvas id="swe-hist-canvas"></canvas>';
                const ctx = document.getElementById('swe-hist-canvas').getContext('2d');
                if (sweChart) { sweChart.destroy(); }
                sweChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.dates,
                        datasets: [
                            {
                                label: 'SWE (mm)',
                                data: data.swe_values,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102,126,234,0.12)',
                                tension: 0.35,
                                spanGaps: true,
                                fill: true
                            },
                            {
                                label: 'Historical Avg (mm)',
                                data: data.historical_average,
                                borderColor: '#999',
                                backgroundColor: 'transparent',
                                tension: 0.35,
                                spanGaps: true,
                                borderDash: [4, 4]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 20,
                                bottom: 40,
                                left: 20
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `SWE Historical (Real-time 2025)`,
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'mm',
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                ticks: {
                                    padding: 10
                                }
                            }
                        }
                    }
                });

                // refresh anomaly view if visible
                if (document.getElementById('swe-anomaly-container').style.display !== 'none') {
                    renderAnomaly();
                }

                // interpretation & summary & provenance
                const interp = document.getElementById('swe-interpretation');
                const summary = document.getElementById('swe-summary');
                const prov = document.getElementById('swe-provenance');
                const sig = data.interpretation?.signal || 'stable';
                const pct = data.interpretation?.percent_vs_historical;
                interp.innerHTML = `
                    <div>
                        Signal: <strong>${sig}</strong>
                        ${pct != null ? `; Last vs historical: <strong>${pct}%</strong>` : ''}
                    </div>`;
                summary.innerHTML = `
                    <div>Count: ${data.summary.count}</div>
                    <div>Mean: ${data.summary.mean_mm ?? '‚Äî'} mm; Std: ${data.summary.std_mm ?? '‚Äî'} mm</div>
                    <div>Min: ${data.summary.min_mm ?? '‚Äî'} mm; Max: ${data.summary.max_mm ?? '‚Äî'} mm</div>
                    <div>Last: ${data.summary.last_value_mm ?? '‚Äî'} mm at ${data.summary.last_date ?? '‚Äî'}</div>`;
                const p = data.provenance || {};
                prov.innerHTML = `<div>Source: <code>${p.source || ''}</code></div>
                                  <div>Path: <code>${p.source_path || ''}</code></div>
                                  <div>Updated: ${p.updated_at || 'unknown'}</div>
                                  <div>Lineage: <code>${p.lineage_id || ''}</code></div>`;
            } catch (err) {
                container.innerHTML = `<div class="error">Failed to load SWE historical: ${err.message}</div>`;
            }
        }

        // Update date inputs to show actual range of current data
        function updateDateInputsFromData(data) {
            const startEl = document.getElementById('swe-start');
            const endEl = document.getElementById('swe-end');
            const windowSel = document.getElementById('swe-window');

            if (data && data.dates && data.dates.length > 0) {
                const firstDate = data.dates[0];
                const lastDate = data.dates[data.dates.length - 1];

                // If "All" is currently selected and date inputs are empty, show actual data range
                if (windowSel.value === 'all' && !startEl.value && !endEl.value) {
                    startEl.value = firstDate;
                    endEl.value = lastDate;
                    startEl.title = `Data Start Date: ${firstDate}`;
                    endEl.title = `Data End Date: ${lastDate}`;
                }
            }
        }

        function bindSWEControls() {
            const windowSel = document.getElementById('swe-window');
            const startEl = document.getElementById('swe-start');
            const endEl = document.getElementById('swe-end');
            const applyBtn = document.getElementById('swe-apply-btn');
            const prevBtn = document.getElementById('swe-prev-page');
            const nextBtn = document.getElementById('swe-next-page');
            const downloadBtn = document.getElementById('swe-download-btn');
            const toggleAnomalyBtn = document.getElementById('swe-toggle-anomaly');
            windowSel.addEventListener('change', () => {
                const isCustom = windowSel.value === 'custom';
                const isAll = windowSel.value === 'all';
                if (isAll) {
                    startEl.disabled = false; // Force enable for all
                    endEl.disabled = false;   // Force enable for all
                    startEl.placeholder = 'Optional start date (leave empty for all data)';
                    endEl.placeholder = 'Optional end date (leave empty for all data)';
                    // If there is data currently, show actual range
                    if (SWE_STATE.last_payload && SWE_STATE.last_payload.dates) {
                        const firstDate = SWE_STATE.last_payload.dates[0];
                        const lastDate = SWE_STATE.last_payload.dates[SWE_STATE.last_payload.dates.length - 1];
                        if (!startEl.value) startEl.value = firstDate;
                        if (!endEl.value) endEl.value = lastDate;
                    }
                } else if (isCustom) {
                    startEl.disabled = false;
                    endEl.disabled = false;
                    startEl.placeholder = 'Start date (required)';
                    endEl.placeholder = 'End date (required)';
                    // Clear date inputs, require user to re-enter
                    startEl.value = '';
                    endEl.value = '';
                } else {
                    startEl.disabled = true;
                    endEl.disabled = true;
                    startEl.placeholder = 'mm/dd/yyyy';
                    endEl.placeholder = 'mm/dd/yyyy';
                    // Clear date inputs
                    startEl.value = '';
                    endEl.value = '';
                }
            });
            applyBtn.addEventListener('click', () => { SWE_STATE.page = 1; loadSWEHistorical(); });
            prevBtn.addEventListener('click', () => { if (SWE_STATE.page > 1) { SWE_STATE.page--; loadSWEHistorical(); } });
            nextBtn.addEventListener('click', () => { if (SWE_STATE.page < SWE_STATE.total_pages) { SWE_STATE.page++; loadSWEHistorical(); } });
            downloadBtn.addEventListener('click', () => { downloadCurrentCSV(); });
            toggleAnomalyBtn.addEventListener('click', () => { toggleAnomaly(); });
        }

        function downloadCurrentCSV() {
            const d = SWE_STATE.last_payload;
            if (!d) return;
            const rows = [
                ['date', 'swe_mm', 'historical_avg_mm'],
                ...d.dates.map((date, i) => [date, d.swe_values[i] ?? '', d.historical_average[i] ?? ''])
            ];
            const csv = rows.map(r => r.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `swe_${Date.now()}.csv`;
            document.body.appendChild(a);
            a.click();
            URL.revokeObjectURL(url);
            a.remove();
        }

        function renderAnomaly() {
            const d = SWE_STATE.last_payload;
            const container = document.getElementById('swe-anomaly-container');
            if (!d || !Array.isArray(d.swe_values) || !Array.isArray(d.historical_average)) {
                container.innerHTML = '<div class="error">No data available for anomaly</div>';
                return;
            }
            const anomaly = d.swe_values.map((v, i) => (v == null || d.historical_average[i] == null) ? null : +(v - d.historical_average[i]).toFixed(2));
            container.innerHTML = '<canvas id="swe-anomaly-canvas"></canvas>';
            const ctx = document.getElementById('swe-anomaly-canvas').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: d.dates,
                    datasets: [{
                        label: 'Anomaly (SWE - Historical Avg) (mm)',
                        data: anomaly,
                        backgroundColor: anomaly.map(x => (x ?? 0) >= 0 ? 'rgba(231,76,60,0.6)' : 'rgba(52,152,219,0.6)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { title: { display: true, text: 'mm' } } }
                }
            });
        }

        function toggleAnomaly() {
            const el = document.getElementById('swe-anomaly-container');
            if (el.style.display === 'none') {
                el.style.display = 'block';
                renderAnomaly();
            } else {
                el.style.display = 'none';
            }
        }

        // Load seasonal analysis with detailed interpretation
        async function loadSeasonalAnalysis() {
            const container = document.getElementById('seasonal-analysis-content');
            const analysisContainer = document.getElementById('seasonal-analysis-detail-content');

            try {
                const data = await apiRequest('/swe/analysis/seasonal');

                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                    'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                // Display metrics
                container.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Peak Month</span>
                        <span class="metric-value">${months[data.peak_month - 1]} (${data.peak_swe} mm)</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Lowest Month</span>
                        <span class="metric-value">${months[data.lowest_month - 1]} (${data.lowest_swe} mm)</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Seasonal Strength</span>
                        <span class="metric-value">${data.seasonal_strength}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Analysis Period</span>
                        <span class="metric-value">${data.analysis_years}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Total Records</span>
                        <span class="metric-value">${data.total_records.toLocaleString()}</span>
                    </div>
                `;

                // Create seasonal chart
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                container.appendChild(chartContainer);

                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);

                const monthlyData = Object.values(data.monthly_averages);
                const ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [{
                            label: 'Average SWE (mm)',
                            data: monthlyData,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Monthly SWE Pattern (1981-2016)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'SWE (mm)'
                                }
                            }
                        }
                    }
                });

                // Detailed analysis
                const peakMonthName = months[data.peak_month - 1];
                const lowestMonthName = months[data.lowest_month - 1];
                const seasonalRange = data.seasonal_range;

                analysisContainer.innerHTML = `
                    <div class="insight">
                        <div class="insight-title">üóìÔ∏è Seasonal Cycle Analysis</div>
                        <div class="insight-content">
                            The seasonal cycle shows a ${data.seasonal_strength}% strength variation, with peak SWE in ${peakMonthName} 
                            (${data.peak_swe} mm) and minimum in ${lowestMonthName} (${data.lowest_swe} mm). This ${data.seasonal_strength}% seasonal strength 
                            indicates ${data.seasonal_strength > 80 ? 'highly pronounced' : data.seasonal_strength > 60 ? 'moderately pronounced' : 'weak'} seasonal variability.
                        </div>
                    </div>
                    
                    <div class="insight">
                        <div class="insight-title">üå®Ô∏è Snow Accumulation Pattern</div>
                        <div class="insight-content">
                            The pattern shows typical boreal climate characteristics with snow accumulation beginning in ${months[data.peak_month - 6]} 
                            and peak accumulation in ${peakMonthName}. The rapid decline after ${peakMonthName} suggests efficient snowmelt processes, 
                            typical of continental climates with spring warming.
                        </div>
                    </div>
                    
                    <div class="prediction">
                        <div class="prediction-title">üîÆ Seasonal Predictions</div>
                        <div class="prediction-content">
                            Based on this ${data.analysis_years} climatology, we can predict that ${peakMonthName} will typically have the highest 
                            flood risk due to peak SWE values. Water resource managers should prepare for maximum runoff potential during 
                            ${months[data.peak_month - 2]} to ${months[data.peak_month + 2]} period.
                        </div>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load seasonal analysis: ${error.message}</div>`;
            }
        }

        // Load forecast with detailed analysis
        async function loadForecast() {
            const container = document.getElementById('forecast-content');
            const analysisContainer = document.getElementById('forecast-analysis-content');

            try {
                const data = await apiRequest('/swe/forecast/7day');

                // Display metrics (data-centric only)
                container.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Forecast Period</span>
                        <span class="metric-value">${data.forecast_period}</span>
                    </div>
                `;

                // Create forecast chart
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                container.appendChild(chartContainer);

                const canvas = document.createElement('canvas');
                chartContainer.appendChild(canvas);

                const ctx = canvas.getContext('2d');

                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.forecast_dates.map(date => new Date(date).toLocaleDateString()),
                        datasets: [{
                            label: 'SWE Forecast (mm)',
                            data: data.swe_forecast_mm,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 10,
                                right: 20,
                                bottom: 40,
                                left: 20
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: '7-Day SWE Forecast',
                                padding: {
                                    top: 10,
                                    bottom: 20
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 0,
                                    padding: 10
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'SWE (mm)',
                                    padding: {
                                        top: 10,
                                        bottom: 10
                                    }
                                },
                                ticks: {
                                    padding: 10
                                }
                            }
                        }
                    }
                });

                // Detailed analysis
                const avgForecast = (data.swe_forecast_mm.reduce((a, b) => a + b, 0) / data.swe_forecast_mm.length).toFixed(1);
                const maxForecast = Math.max(...data.swe_forecast_mm);
                const minForecast = Math.min(...data.swe_forecast_mm);
                const trend = data.swe_forecast_mm[data.swe_forecast_mm.length - 1] - data.swe_forecast_mm[0];

                analysisContainer.innerHTML = `
                    <div class="insight">
                        <div class="insight-title">üìä Forecast Analysis</div>
                        <div class="insight-content">
                            The ${data.forecast_period} forecast shows an average SWE of ${avgForecast} mm, ranging from ${minForecast} mm to ${maxForecast} mm. 
                            The trend over the forecast period is ${trend > 0 ? 'increasing' : trend < 0 ? 'decreasing' : 'stable'} 
                            (${Math.abs(trend).toFixed(1)} mm change), indicating ${trend > 0 ? 'accumulation' : trend < 0 ? 'melt' : 'stable conditions'}.
                        </div>
                    </div>
                    
                    <div class="prediction">
                        <div class="prediction-title">üîÆ Hydrological Implications</div>
                        <div class="prediction-content">
                            ${trend > 0 ?
                        'Increasing SWE suggests continued snow accumulation, potentially leading to higher spring runoff volumes.' :
                        trend < 0 ?
                            'Decreasing SWE indicates snowmelt processes, with implications for immediate water availability and flood risk.' :
                            'Stable SWE conditions suggest consistent water storage, maintaining current hydrological balance.'
                    }
                        </div>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load forecast: ${error.message}</div>`;
            }
        }

        // Load regional forecast with detailed analysis
        async function loadRegionalForecast() {
            const container = document.getElementById('regional-forecast-content');
            const analysisContainer = document.getElementById('regional-analysis-content');

            try {
                const data = await apiRequest('/swe/regional-forecast');

                // Display metrics
                container.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Forecast Date</span>
                        <span class="metric-value">${data.forecast_date}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Overall SWE</span>
                        <span class="metric-value">${data.overall_swe_mm} mm</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Provincial Average</span>
                        <span class="metric-value">${data.provincial_average_mm} mm</span>
                    </div>
                `;

                // Add regional data
                Object.values(data.regional_forecasts).forEach(region => {
                    const regionDiv = document.createElement('div');
                    regionDiv.className = 'metric';
                    regionDiv.innerHTML = `
                        <span class="metric-label">${region.region_name}</span>
                        <span class="metric-value">${region.current_swe_mm} mm</span>
                    `;
                    container.appendChild(regionDiv);
                });

                // Detailed analysis
                const regions = Object.values(data.regional_forecasts);
                const highestRegion = regions.reduce((prev, current) => (prev.current_swe_mm > current.current_swe_mm) ? prev : current);
                const lowestRegion = regions.reduce((prev, current) => (prev.current_swe_mm < current.current_swe_mm) ? prev : current);

                analysisContainer.innerHTML = `
                    <div class="insight">
                        <div class="insight-title">üó∫Ô∏è Regional Variability</div>
                        <div class="insight-content">
                            Regional SWE varies significantly across Manitoba, from ${lowestRegion.current_swe_mm} mm in ${lowestRegion.region_name} 
                            to ${highestRegion.current_swe_mm} mm in ${highestRegion.region_name}. This ${((highestRegion.current_swe_mm / lowestRegion.current_swe_mm - 1) * 100).toFixed(1)}% 
                            variation reflects the province's diverse topography and climate zones.
                        </div>
                    </div>
                    
                    <div class="insight">
                        <div class="insight-title">üèîÔ∏è Geographic Patterns</div>
                        <div class="insight-content">
                            ${highestRegion.region_name} shows the highest SWE values, consistent with its higher elevation (${highestRegion.elevation_range}) 
                            and boreal forest characteristics. ${lowestRegion.region_name} has lower values due to its ${lowestRegion.elevation_range} 
                            elevation and ${lowestRegion.description.toLowerCase()}.
                        </div>
                    </div>
                    
                    <div class="prediction">
                        <div class="prediction-title">üîÆ Regional Risk Assessment</div>
                        <div class="prediction-content">
                            ${highestRegion.region_name} faces the highest flood risk due to elevated SWE levels, while ${lowestRegion.region_name} 
                            may experience water availability challenges. Water resource managers should prioritize flood preparedness in northern regions 
                            and drought monitoring in southern agricultural areas.
                        </div>
                    </div>
                `;

            } catch (error) {
                container.innerHTML = `<div class="error">Failed to load regional forecast: ${error.message}</div>`;
            }
        }


        // Load flood prediction data
        async function loadFloodPrediction() {
            const container = document.getElementById('flood-prediction-content');
            // Remove fixed height class to allow content to expand
            container.classList.remove('chart-container');
            const interpretationContainer = document.getElementById('flood-prediction-interpretation');
            const provenanceContainer = document.getElementById('flood-prediction-provenance');

            try {
                const data = await apiRequest('/flood/prediction/7day');

                // Handle different response formats (success/partial/error)
                if (data && data.flood_risk_scores && Array.isArray(data.flood_risk_scores) && data.flood_risk_scores.length > 0) {
                    // Display flood risk metrics
                    const avgRisk = data.flood_risk_scores.reduce((a, b) => a + b, 0) / data.flood_risk_scores.length;
                    const maxRisk = Math.max(...data.flood_risk_scores);
                    const highRiskDays = data.flood_risk_scores.filter(risk => risk > 70).length;

                    container.innerHTML = `
                        <div class="metric">
                            <span class="metric-label">Average Risk</span>
                            <span class="metric-value">${avgRisk.toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Peak Risk</span>
                            <span class="metric-value">${maxRisk.toFixed(1)}%</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">High Risk Days</span>
                            <span class="metric-value">${highRiskDays}/7</span>
                        </div>
                    `;

                    // Create flood risk chart
                    const chartContainer = document.createElement('div');
                    chartContainer.className = 'chart-container';
                    container.appendChild(chartContainer);

                    const canvas = document.createElement('canvas');
                    chartContainer.appendChild(canvas);

                    const ctx = canvas.getContext('2d');

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: data.forecast_dates.map(date => new Date(date).toLocaleDateString()),
                            datasets: [{
                                label: 'Flood Risk (%)',
                                data: data.flood_risk_scores,
                                borderColor: '#e74c3c',
                                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    top: 10,
                                    right: 20,
                                    bottom: 40,
                                    left: 20
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        maxRotation: 45,
                                        minRotation: 0,
                                        padding: 10
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Risk Probability (%)',
                                        padding: {
                                            top: 10,
                                            bottom: 10
                                        }
                                    },
                                    ticks: {
                                        padding: 10
                                    }
                                }
                            },
                            plugins: {
                                title: {
                                    display: true,
                                    text: '7-Day Flood Risk Prediction',
                                    padding: {
                                        top: 10,
                                        bottom: 20
                                    }
                                },
                                legend: {
                                    display: true,
                                    position: 'top',
                                    padding: 10
                                }
                            }
                        }
                    });

                    // Expert interpretation
                    const riskTrend = data.flood_risk_scores[data.flood_risk_scores.length - 1] > data.flood_risk_scores[0] ? 'increasing' : 'decreasing';

                    interpretationContainer.innerHTML = `
                        <div class="insight">
                            <div class="insight-title">üö® Risk Assessment Summary</div>
                            <div class="insight-content">
                                <strong>Peak Risk:</strong> ${maxRisk.toFixed(1)}%<br>
                                <strong>Average Risk:</strong> ${avgRisk.toFixed(1)}% over 7-day period<br>
                                <strong>Risk Trend:</strong> ${riskTrend} over the forecast period<br>
                                <strong>High Risk Days:</strong> ${highRiskDays} out of 7 days (${((highRiskDays / 7) * 100).toFixed(1)}%)
                            </div>
                        </div>
                        
                        <div class="insight">
                            <div class="insight-title">üåä Hydrological Factors</div>
                            <div class="insight-content">
                                <strong>Snow Water Equivalent:</strong> Current SWE levels are ${avgRisk > 60 ? 'significantly elevated' : avgRisk > 30 ? 'moderately elevated' : 'within normal ranges'}<br>
                                <strong>Precipitation Forecast:</strong> ${data.flood_risk_scores.some(risk => risk > 70) ? 'Heavy precipitation expected' : 'Moderate precipitation forecast'}<br>
                                <strong>Temperature Impact:</strong> ${riskTrend === 'increasing' ? 'Rising temperatures may accelerate snowmelt' : 'Stable temperatures maintain current conditions'}<br>
                                <strong>River Levels:</strong> ${maxRisk > 80 ? 'Critical levels expected' : maxRisk > 50 ? 'Elevated levels anticipated' : 'Normal levels maintained'}
                            </div>
                        </div>
                        
                        <div class="prediction">
                            <div class="prediction-title">‚ö†Ô∏è Government Action Recommendations</div>
                            <div class="prediction-content">
                                ${highRiskDays > 2 ?
                            '<strong>IMMEDIATE ACTION REQUIRED:</strong> Multiple high-risk days detected. Consider emergency preparedness measures, public advisories, and resource mobilization.' :
                            highRiskDays > 0 ?
                                '<strong>MONITORING REQUIRED:</strong> High-risk periods identified. Increase monitoring frequency and prepare contingency plans.' :
                                '<strong>NORMAL OPERATIONS:</strong> Low risk levels maintained. Continue standard monitoring protocols.'
                        }<br><br>
                                <strong>Recommended Actions:</strong><br>
                                ‚Ä¢ ${maxRisk > 70 ? 'Activate emergency response protocols' : 'Maintain standard monitoring'}<br>
                                ‚Ä¢ ${highRiskDays > 0 ? 'Issue public flood advisories' : 'Continue routine communications'}<br>
                                ‚Ä¢ ${avgRisk > 50 ? 'Deploy additional monitoring equipment' : 'Maintain current monitoring capacity'}<br>
                                ‚Ä¢ ${riskTrend === 'increasing' ? 'Prepare for escalating conditions' : 'Monitor for trend changes'}
                            </div>
                        </div>
                    `;

                    // Provenance information
                    if (data.data_sources && typeof data.data_sources === 'object') {
                        provenanceContainer.innerHTML = `
                            <div class="provenance-item">
                                <strong>Data Sources:</strong> ${Object.keys(data.data_sources).join(', ')}
                            </div>
                            <div class="provenance-item">
                                <strong>Methodology:</strong> ${data.methodology || 'Multi-factor flood risk assessment'}
                            </div>
                            <div class="provenance-item">
                                <strong>Last Updated:</strong> ${data.last_update ? new Date(data.last_update).toLocaleString() : new Date().toLocaleString()}
                            </div>
                        `;
                    } else {
                        provenanceContainer.innerHTML = `
                            <div class="provenance-item">
                                <strong>Status:</strong> ${data.status || 'unknown'}
                            </div>
                            <div class="provenance-item">
                                <strong>Message:</strong> ${data.message || 'Flood prediction data'}
                            </div>
                        `;
                    }
                } else {
                    // Handle incomplete data or partial/error status
                    const statusMessage = data.status === 'partial' ? data.message || 'Partial data unavailable' :
                        data.status === 'error' ? data.message || 'Flood prediction service temporarily unavailable' :
                            'Incorrect data format';

                    container.innerHTML = `
                        <div class="info-message" style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; margin: 10px 0;">
                            <strong>‚ö†Ô∏è ${statusMessage}</strong>
                            ${data.warning ? `<br><small>${data.warning}</small>` : ''}
                            ${data.flood_risk_scores && data.flood_risk_scores.length > 0 ?
                            `<div style="margin-top: 10px;">
                                    <small>Current Prediction (Est): Avg Risk ${(data.flood_risk_scores.reduce((a, b) => a + b, 0) / data.flood_risk_scores.length).toFixed(1)}%</small>
                                </div>` : ''
                        }
                        </div>
                    `;

                    interpretationContainer.innerHTML = `
                        <div class="insight">
                            <div class="insight-title">‚ö†Ô∏è Data Status</div>
                            <div class="insight-content">
                                ${statusMessage}<br>
                                ${data.error ? `<br><small>Technical Details: ${data.error}</small>` : ''}
                            </div>
                        </div>
                    `;

                    // Provenance information for partial/error cases
                    provenanceContainer.innerHTML = `
                        <div class="provenance-item">
                            <strong>Status:</strong> ${data.status || 'unknown'}
                        </div>
                        <div class="provenance-item">
                            <strong>Message:</strong> ${data.message || 'No additional information'}
                        </div>
                        ${data.warning ? `<div class="provenance-item"><strong>Warning:</strong> ${data.warning}</div>` : ''}
                        ${data.error ? `<div class="provenance-item"><strong>Error:</strong> ${data.error}</div>` : ''}
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading flood prediction: ${error.message}</div>`;
                console.error('Flood prediction error:', error);
            }
        }

        // Load water quality analysis data
        async function loadWaterQuality() {
            const container = document.getElementById('water-quality-content');
            // Remove fixed height class to allow content to expand
            container.classList.remove('chart-container');
            const interpretationContainer = document.getElementById('water-quality-interpretation');
            const provenanceContainer = document.getElementById('water-quality-provenance');

            try {
                const data = await apiRequest('/water-quality/analysis/current');

                // Handle different response formats
                if (data && data.status === 'success' && data.data) {
                    // Check for complete data structure (nested format)
                    if (data.data.overall_assessment && data.data.monitoring_points && data.data.monitoring_points.distribution_system) {
                        const assessment = data.data.overall_assessment;
                        const parameters = data.data.monitoring_points.distribution_system.parameters;

                        // Create summary display
                        const summary = `
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" style="color: ${assessment.status === 'excellent' ? '#27ae60' : '#f39c12'}">${assessment.status}</div>
                                <div class="summary-label">Overall Quality</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${assessment.compliance_rate}%</div>
                                <div class="summary-label">Compliance Rate</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value">${Object.keys(parameters).length}</div>
                                <div class="summary-label">Parameters Tested</div>
                            </div>
                        </div>
                    `;

                        container.innerHTML = summary;

                        // Create water quality parameters chart
                        const chartContainer = document.createElement('div');
                        chartContainer.className = 'chart-container';
                        container.appendChild(chartContainer);

                        const canvas = document.createElement('canvas');
                        chartContainer.appendChild(canvas);

                        const paramNames = Object.keys(parameters);
                        const paramValues = paramNames.map(name => parameters[name].value);
                        const paramLabels = paramNames.map(name => parameters[name].description);
                        const paramColors = paramNames.map(name => {
                            const status = parameters[name].status;
                            return status === 'compliant' ? '#27ae60' : '#e74c3c';
                        });

                        new Chart(canvas, {
                            type: 'bar',
                            data: {
                                labels: paramLabels,
                                datasets: [{
                                    label: 'Parameter Values',
                                    data: paramValues,
                                    backgroundColor: paramColors,
                                    borderColor: paramColors,
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Parameter Values'
                                        }
                                    }
                                },
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Water Quality Parameters - Winnipeg Distribution System'
                                    }
                                }
                            }
                        });

                        // Expert interpretation
                        interpretationContainer.innerHTML = `
                        <div class="insight">
                            <div class="insight-title">üìä Water Quality Assessment</div>
                            <div class="insight-content">
                                ${assessment.summary}. The distribution system shows 
                                ${assessment.compliance_rate}% compliance with Canadian drinking water guidelines.
                            </div>
                        </div>

                        <div class="prediction">
                            <div class="prediction-title">üî¨ Key Parameters</div>
                            <div class="prediction-content">
                                <strong>Chlorine Residual:</strong> ${parameters.chlorine_free.value} mg/L (Standard: ${parameters.chlorine_free.standard})<br>
                                <strong>pH Level:</strong> ${parameters.ph.value} (Standard: ${parameters.ph.standard})<br>
                                <strong>Turbidity:</strong> ${parameters.turbidity.value} NTU (Standard: ${parameters.turbidity.standard})<br>
                                <strong>Bacterial Tests:</strong> All within acceptable limits
                            </div>
                        </div>

                        <div class="prediction">
                            <div class="prediction-title">üèõÔ∏è Government Action</div>
                            <div class="prediction-content">
                                Water quality monitoring continues at 60 distribution system locations weekly. 
                                All parameters are within Health Canada guidelines. No immediate action required.
                            </div>
                        </div>
                    `;

                        // Provenance information
                        if (data.data.provenance) {
                            provenanceContainer.innerHTML = `
                            <div class="provenance-item">
                                <strong>Data Source:</strong> ${data.data.provenance.data_authority || 'Winnipeg Water Quality'}
                            </div>
                            <div class="provenance-item">
                                <strong>Source URL:</strong> ${data.data.provenance.source_url ? `<a href="${data.data.provenance.source_url}" target="_blank">Winnipeg Water Quality Test Results</a>` : 'N/A'}
                            </div>
                            <div class="provenance-item">
                                <strong>Guidelines:</strong> ${data.data.provenance.guidelines || 'Health Canada'}
                            </div>
                            <div class="provenance-item">
                                <strong>Last Updated:</strong> ${data.data.last_updated ? new Date(data.data.last_updated).toLocaleString() : new Date().toLocaleString()}
                            </div>
                        `;
                        }
                    } else {
                        // Â§ÑÁêÜÁÆÄÂåñÁöÑÊï∞ÊçÆÁªìÊûÑÔºàÊâÅÂπ≥Ê†ºÂºèÔºâ
                        const simpleData = data.data;

                        container.innerHTML = `
                            <div class="summary-grid">
                                <div class="summary-item">
                                    <div class="summary-value" style="color: ${simpleData.overall_score >= 8 ? '#27ae60' : '#f39c12'}">${simpleData.overall_score || 'N/A'}</div>
                                    <div class="summary-label">Overall Score</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${simpleData.turbidity || 'N/A'}</div>
                                    <div class="summary-label">Turbidity</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${simpleData.chlorine || 'N/A'}</div>
                                    <div class="summary-label">Chlorine</div>
                                </div>
                                <div class="summary-item">
                                    <div class="summary-value">${simpleData.ph || 'N/A'}</div>
                                    <div class="summary-label">pH Level</div>
                                </div>
                            </div>
                            ${simpleData.note ? `<div class="info-message" style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">${simpleData.note}</div>` : ''}
                        `;

                        interpretationContainer.innerHTML = `
                            <div class="insight">
                                <div class="insight-title">üìä Water Quality Summary</div>
                                <div class="insight-content">
                                    <strong>Overall Score:</strong> ${simpleData.overall_score || 'N/A'}/10<br>
                                    <strong>Turbidity:</strong> ${simpleData.turbidity || 'N/A'}<br>
                                    <strong>Chlorine:</strong> ${simpleData.chlorine || 'N/A'}<br>
                                    <strong>pH Level:</strong> ${simpleData.ph || 'N/A'}<br>
                                    ${data.message ? `<br><strong>Note:</strong> ${data.message}` : ''}
                                </div>
                            </div>
                        `;

                        provenanceContainer.innerHTML = `
                            <div class="provenance-item">
                                <strong>Data Source:</strong> ${data.message || 'Water Quality Service'}
                            </div>
                            <div class="provenance-item">
                                <strong>Status:</strong> ${data.status || 'success'}
                            </div>
                        `;
                    }
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÊï∞ÊçÆÊàñÁä∂ÊÄÅ‰∏çÊòØsuccess
                    container.innerHTML = `
                        <div class="info-message" style="padding: 15px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                            <strong>‚ö†Ô∏è ${data && data.message ? data.message : 'Ê∞¥Ë¥®Êï∞ÊçÆÊöÇÊó∂‰∏çÂèØÁî®'}</strong>
                        </div>
                    `;
                    interpretationContainer.innerHTML = `
                        <div class="insight">
                            <div class="insight-title">‚ö†Ô∏è Êï∞ÊçÆÁä∂ÊÄÅ</div>
                            <div class="insight-content">
                                ${data && data.message ? data.message : 'Ê∞¥Ë¥®ÂàÜÊûêÊúçÂä°ÊöÇÊó∂‰∏çÂèØÁî®ÔºåËØ∑Á®çÂêéÈáçËØï'}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                container.innerHTML = `<div class="error">Error loading water quality analysis: ${error.message}</div>`;
                console.error('Water quality error:', error);
            }
        }

        // Load all data
        async function loadAllData() {
            try {
                await Promise.all([
                    loadSWEHistorical(),
                    loadFloodPrediction(),
                    loadWaterQuality()
                ]);
                document.getElementById('last-update').textContent =
                    `Last updated: ${new Date().toLocaleString()}`;
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        // Refresh all data
        function refreshAllData() {
            document.getElementById('last-update').textContent = 'Refreshing...';
            loadAllData();
        }

        // Load Data Sync Status
        async function loadSyncStatus() {
            try {
                const data = await apiRequest('/sync/status');
                const sources = data.sources || {};

                const formatDate = (isoStr) => {
                    if (!isoStr) return 'N/A';
                    const d = new Date(isoStr);
                    return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                };

                document.getElementById('status-mb-flood').textContent = formatDate(sources.mb_flood_alerts?.last_update) || 'Real-time';
                document.getElementById('status-rdps').textContent = formatDate(sources.rdps_precip?.last_update) || '4x Daily';
                document.getElementById('status-river').textContent = formatDate(sources.wpg_river_levels?.last_update) || 'Real-time';
                document.getElementById('status-water').textContent = formatDate(sources.wpg_water_quality?.last_update) || '2024 Data';

            } catch (error) {
                console.error('Error loading sync status:', error);
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            console.log('HydrAI-SWE Enhanced Dashboard initialized');
            bindSWEControls();

            // Initialize date picker state
            const windowSel = document.getElementById('swe-window');
            const startEl = document.getElementById('swe-start');
            const endEl = document.getElementById('swe-end');
            if (windowSel && startEl && endEl && windowSel.value === 'all') {
                startEl.disabled = false;
                endEl.disabled = false;
                startEl.placeholder = 'Optional start date';
                endEl.placeholder = 'Optional end date';
            }

            loadSyncStatus();
            loadAllData();
        });
    </script>
</body>

</html>