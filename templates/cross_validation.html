<!-- äº¤å‰éªŒè¯é¢æ¿ -->
<div id="crossValidationPanel" class="cross-validation-panel" style="display: none;">
    <div class="panel-header">
        <h3>ğŸŒŠ å†å²æ•°æ®äº¤å‰éªŒè¯</h3>
        <button onclick="closeCrossValidationPanel()" class="close-btn">Ã—</button>
    </div>
    
    <div class="panel-content">
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="config-section">
            <h4>éªŒè¯é…ç½®</h4>
            <div class="form-group">
                <label for="cvStartDate">å¼€å§‹æ—¥æœŸ:</label>
                <input type="date" id="cvStartDate" value="2024-01-01">
            </div>
            <div class="form-group">
                <label for="cvEndDate">ç»“æŸæ—¥æœŸ:</label>
                <input type="date" id="cvEndDate" value="2024-01-31">
            </div>
            <div class="form-group">
                <label for="cvStation">æ°´æ–‡ç«™ç‚¹:</label>
                <select id="cvStation">
                    <option value="05OC001">05OC001 - Red River at Emerson</option>
                    <option value="05OC011">05OC011 - Red River at Winnipeg</option>
                    <option value="05OC012">05OC012 - Red River at Lockport</option>
                </select>
            </div>
            <div class="form-group">
                <label for="cvWindowSize">éªŒè¯çª—å£å¤§å° (å¤©):</label>
                <input type="number" id="cvWindowSize" value="30" min="7" max="90">
            </div>
            <div class="form-group">
                <label for="cvStepSize">æ­¥é•¿ (å¤©):</label>
                <input type="number" id="cvStepSize" value="7" min="1" max="30">
            </div>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        <div class="action-section">
            <button onclick="startCrossValidation()" class="btn btn-primary">ğŸš€ å¼€å§‹äº¤å‰éªŒè¯</button>
            <button onclick="quickCrossValidation()" class="btn btn-secondary">âš¡ å¿«é€ŸéªŒè¯</button>
            <button onclick="checkCVStatus()" class="btn btn-info">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
        </div>
        
        <!-- çŠ¶æ€æ˜¾ç¤º -->
        <div class="status-section">
            <div id="cvStatus" class="status-info">
                <p>å‡†å¤‡å°±ç»ªï¼Œè¯·é…ç½®å‚æ•°å¹¶å¼€å§‹éªŒè¯</p>
            </div>
            <div id="cvProgress" class="progress-bar" style="display: none;">
                <div class="progress-fill"></div>
            </div>
        </div>
        
        <!-- ç»“æœå±•ç¤º -->
        <div class="results-section" style="display: none;">
            <h4>éªŒè¯ç»“æœ</h4>
            <div id="cvResults" class="results-content">
                <!-- ç»“æœå°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
            </div>
            
            <!-- ä¸‹è½½æŒ‰é’® -->
            <div class="download-section">
                <button onclick="downloadCVReport()" class="btn btn-success">ğŸ“¥ ä¸‹è½½æŠ¥å‘Š</button>
                <button onclick="downloadCVPlots()" class="btn btn-success">ğŸ“Š ä¸‹è½½å›¾è¡¨</button>
            </div>
        </div>
        
        <!-- ä»»åŠ¡åˆ—è¡¨ -->
        <div class="tasks-section">
            <h4>éªŒè¯ä»»åŠ¡</h4>
            <div id="cvTasks" class="tasks-list">
                <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
            </div>
        </div>
    </div>
</div>

<style>
.cross-validation-panel {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    margin: 20px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.panel-header {
    background: #f8f9fa;
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.panel-header h3 {
    margin: 0;
    color: #333;
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
}

.close-btn:hover {
    color: #333;
}

.panel-content {
    padding: 20px;
}

.config-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.config-section h4 {
    margin-top: 0;
    color: #555;
}

.form-group {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
}

.form-group label {
    width: 120px;
    font-weight: 500;
    color: #333;
}

.form-group input,
.form-group select {
    flex: 1;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.action-section {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-info:hover {
    background: #117a8b;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
}

.status-section {
    background: #e9ecef;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.status-info {
    margin-bottom: 15px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #dee2e6;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #007bff;
    width: 0%;
    transition: width 0.3s ease;
}

.results-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
}

.results-content {
    margin-bottom: 15px;
}

.download-section {
    display: flex;
    gap: 10px;
}

.tasks-section {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 6px;
}

.tasks-list {
    max-height: 200px;
    overflow-y: auto;
}

.task-item {
    background: white;
    padding: 10px;
    margin-bottom: 8px;
    border-radius: 4px;
    border-left: 4px solid #007bff;
}

.task-item.completed {
    border-left-color: #28a745;
}

.task-item.failed {
    border-left-color: #dc3545;
}

.task-item.running {
    border-left-color: #ffc107;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .form-group {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .form-group label {
        width: 100%;
        margin-bottom: 5px;
    }
    
    .action-section {
        flex-direction: column;
    }
    
    .btn {
        width: 100%;
    }
}
</style>

<script>
// äº¤å‰éªŒè¯ç›¸å…³å‡½æ•°
let currentCVTaskId = null;
let cvStatusCheckInterval = null;

// æ˜¾ç¤ºäº¤å‰éªŒè¯é¢æ¿
function showCrossValidationPanel() {
    document.getElementById('crossValidationPanel').style.display = 'block';
    loadCVTasks();
}

// å…³é—­äº¤å‰éªŒè¯é¢æ¿
function closeCrossValidationPanel() {
    document.getElementById('crossValidationPanel').style.display = 'none';
    if (cvStatusCheckInterval) {
        clearInterval(cvStatusCheckInterval);
        cvStatusCheckInterval = null;
    }
}

// å¼€å§‹äº¤å‰éªŒè¯
async function startCrossValidation() {
    const startDate = document.getElementById('cvStartDate').value;
    const endDate = document.getElementById('cvEndDate').value;
    const station = document.getElementById('cvStation').value;
    const windowSize = parseInt(document.getElementById('cvWindowSize').value);
    const stepSize = parseInt(document.getElementById('cvStepSize').value);
    
    if (!startDate || !endDate || !station) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¿…éœ€çš„å‚æ•°');
        return;
    }
    
    try {
        // æ˜¾ç¤ºè¿›åº¦æ¡
        document.getElementById('cvProgress').style.display = 'block';
        document.getElementById('cvStatus').innerHTML = '<p>æ­£åœ¨å¯åŠ¨äº¤å‰éªŒè¯ä»»åŠ¡...</p>';
        
        const response = await fetch('/api/v1/cross-validation/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                start_date: startDate,
                end_date: endDate,
                station_id: station,
                window_size: windowSize,
                step_size: stepSize
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            currentCVTaskId = result.task_id;
            
            document.getElementById('cvStatus').innerHTML = 
                `<p>âœ… ä»»åŠ¡å·²å¯åŠ¨ï¼Œä»»åŠ¡ID: ${currentCVTaskId}</p>`;
            
            // å¼€å§‹å®šæœŸæ£€æŸ¥çŠ¶æ€
            startStatusChecking();
            
        } else {
            const error = await response.json();
            document.getElementById('cvStatus').innerHTML = 
                `<p>âŒ å¯åŠ¨å¤±è´¥: ${error.detail}</p>`;
        }
        
    } catch (error) {
        document.getElementById('cvStatus').innerHTML = 
            `<p>âŒ é”™è¯¯: ${error.message}</p>`;
    }
}

// å¿«é€Ÿäº¤å‰éªŒè¯
async function quickCrossValidation() {
    try {
        document.getElementById('cvStatus').innerHTML = '<p>æ­£åœ¨æ‰§è¡Œå¿«é€ŸéªŒè¯...</p>';
        
        const response = await fetch('/api/v1/cross-validation/quick', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                start_date: '2024-01-01',
                end_date: '2024-01-07',
                station_id: '05OC001'
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            displayCVResults(result);
            document.getElementById('cvStatus').innerHTML = 
                '<p>âœ… å¿«é€ŸéªŒè¯å®Œæˆ</p>';
        } else {
            const error = await response.json();
            document.getElementById('cvStatus').innerHTML = 
                `<p>âŒ å¿«é€ŸéªŒè¯å¤±è´¥: ${error.detail}</p>`;
        }
        
    } catch (error) {
        document.getElementById('cvStatus').innerHTML = 
            `<p>âŒ é”™è¯¯: ${error.message}</p>`;
    }
}

// æ£€æŸ¥äº¤å‰éªŒè¯çŠ¶æ€
async function checkCVStatus() {
    if (!currentCVTaskId) {
        alert('è¯·å…ˆå¯åŠ¨ä¸€ä¸ªéªŒè¯ä»»åŠ¡');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/cross-validation/status/${currentCVTaskId}`);
        
        if (response.ok) {
            const status = await response.json();
            updateCVStatus(status);
            
            if (status.status === 'completed') {
                // ä»»åŠ¡å®Œæˆï¼Œè·å–ç»“æœ
                await loadCVResults(currentCVTaskId);
                stopStatusChecking();
            }
        } else {
            document.getElementById('cvStatus').innerHTML = 
                '<p>âŒ æ— æ³•è·å–ä»»åŠ¡çŠ¶æ€</p>';
        }
        
    } catch (error) {
        document.getElementById('cvStatus').innerHTML = 
            `<p>âŒ é”™è¯¯: ${error.message}</p>`;
    }
}

// å¼€å§‹çŠ¶æ€æ£€æŸ¥
function startStatusChecking() {
    if (cvStatusCheckInterval) {
        clearInterval(cvStatusCheckInterval);
    }
    
    cvStatusCheckInterval = setInterval(async () => {
        if (currentCVTaskId) {
            await checkCVStatus();
        }
    }, 5000); // æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
}

// åœæ­¢çŠ¶æ€æ£€æŸ¥
function stopStatusChecking() {
    if (cvStatusCheckInterval) {
        clearInterval(cvStatusCheckInterval);
        cvStatusCheckInterval = null;
    }
}

// æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateCVStatus(status) {
    const statusDiv = document.getElementById('cvStatus');
    const progressBar = document.querySelector('.progress-fill');
    
    let statusHtml = `<p><strong>ä»»åŠ¡çŠ¶æ€:</strong> ${status.status}</p>`;
    
    if (status.progress) {
        statusHtml += `<p><strong>è¿›åº¦:</strong> ${status.progress}%</p>`;
        progressBar.style.width = `${status.progress}%`;
    }
    
    if (status.message) {
        statusHtml += `<p><strong>æ¶ˆæ¯:</strong> ${status.message}</p>`;
    }
    
    if (status.estimated_completion) {
        statusHtml += `<p><strong>é¢„è®¡å®Œæˆæ—¶é—´:</strong> ${status.estimated_completion}</p>`;
    }
    
    statusDiv.innerHTML = statusHtml;
}

// åŠ è½½éªŒè¯ç»“æœ
async function loadCVResults(taskId) {
    try {
        const response = await fetch(`/api/v1/cross-validation/download/${taskId}/report`);
        
        if (response.ok) {
            const result = await response.json();
            displayCVResults(result);
        } else {
            document.getElementById('cvStatus').innerHTML = 
                '<p>âŒ æ— æ³•è·å–éªŒè¯ç»“æœ</p>';
        }
        
    } catch (error) {
        document.getElementById('cvStatus').innerHTML = 
            `<p>âŒ é”™è¯¯: ${error.message}</p>`;
    }
}

// æ˜¾ç¤ºéªŒè¯ç»“æœ
function displayCVResults(result) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('cvResults');
    
    let resultsHtml = '<div class="results-summary">';
    
    if (result.overall_metrics) {
        resultsHtml += `
            <h5>æ•´ä½“æ€§èƒ½æŒ‡æ ‡</h5>
            <div class="metrics-grid">
                <div class="metric-item">
                    <span class="metric-label">é¢„æµ‹MSE:</span>
                    <span class="metric-value">${result.overall_metrics.prediction_mse?.mean?.toFixed(4) || 'N/A'}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">é¢„æµ‹MAE:</span>
                    <span class="metric-value">${result.overall_metrics.prediction_mae?.mean?.toFixed(4) || 'N/A'}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">é¢„æµ‹RÂ²:</span>
                    <span class="metric-value">${result.overall_metrics.prediction_r2?.mean?.toFixed(4) || 'N/A'}</span>
                </div>
                <div class="metric-item">
                    <span class="metric-label">é£é™©è¯„ä¼°åˆ†æ•°:</span>
                    <span class="metric-value">${result.overall_metrics.risk_assessment_score?.mean?.toFixed(4) || 'N/A'}</span>
                </div>
            </div>
        `;
    }
    
    if (result.station_metrics) {
        resultsHtml += `
            <h5>ç«™ç‚¹æ€§èƒ½æŒ‡æ ‡</h5>
            <div class="station-metrics">
                ${Object.entries(result.station_metrics).map(([station, metrics]) => `
                    <div class="station-item">
                        <h6>ç«™ç‚¹ ${station}</h6>
                        <p>MSE: ${metrics.prediction_mse?.mean?.toFixed(4) || 'N/A'}</p>
                        <p>MAE: ${metrics.prediction_mae?.mean?.toFixed(4) || 'N/A'}</p>
                        <p>RÂ²: ${metrics.prediction_r2?.mean?.toFixed(4) || 'N/A'}</p>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    resultsHtml += '</div>';
    
    resultsContent.innerHTML = resultsHtml;
    resultsSection.style.display = 'block';
}

// åŠ è½½ä»»åŠ¡åˆ—è¡¨
async function loadCVTasks() {
    try {
        const response = await fetch('/api/v1/cross-validation/tasks');
        
        if (response.ok) {
            const tasks = await response.json();
            displayCVTasks(tasks);
        }
        
    } catch (error) {
        console.error('åŠ è½½ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
    }
}

// æ˜¾ç¤ºä»»åŠ¡åˆ—è¡¨
function displayCVTasks(tasks) {
    const tasksDiv = document.getElementById('cvTasks');
    
    if (!tasks || tasks.length === 0) {
        tasksDiv.innerHTML = '<p>æš‚æ— éªŒè¯ä»»åŠ¡</p>';
        return;
    }
    
    let tasksHtml = '';
    
    tasks.forEach(task => {
        const statusClass = task.status === 'completed' ? 'completed' : 
                           task.status === 'failed' ? 'failed' : 'running';
        
        tasksHtml += `
            <div class="task-item ${statusClass}">
                <div class="task-header">
                    <strong>ä»»åŠ¡ID:</strong> ${task.task_id}
                    <span class="task-status">${task.status}</span>
                </div>
                <div class="task-details">
                    <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${task.created_at}</p>
                    <p><strong>ç«™ç‚¹:</strong> ${task.station_id || 'N/A'}</p>
                    <p><strong>æ—¶é—´èŒƒå›´:</strong> ${task.start_date || 'N/A'} åˆ° ${task.end_date || 'N/A'}</p>
                </div>
                <div class="task-actions">
                    <button onclick="viewTaskDetails('${task.task_id}')" class="btn btn-sm btn-info">æŸ¥çœ‹è¯¦æƒ…</button>
                    <button onclick="deleteTask('${task.task_id}')" class="btn btn-sm btn-danger">åˆ é™¤</button>
                </div>
            </div>
        `;
    });
    
    tasksDiv.innerHTML = tasksHtml;
}

// æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
async function viewTaskDetails(taskId) {
    try {
        const response = await fetch(`/api/v1/cross-validation/status/${taskId}`);
        
        if (response.ok) {
            const status = await response.json();
            currentCVTaskId = taskId;
            updateCVStatus(status);
            
            if (status.status === 'completed') {
                await loadCVResults(taskId);
            }
        }
        
    } catch (error) {
        console.error('è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
    }
}

// åˆ é™¤ä»»åŠ¡
async function deleteTask(taskId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/cross-validation/task/${taskId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
            loadCVTasks(); // é‡æ–°åŠ è½½ä»»åŠ¡åˆ—è¡¨
        } else {
            alert('åˆ é™¤å¤±è´¥');
        }
        
    } catch (error) {
        alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
    }
}

// ä¸‹è½½éªŒè¯æŠ¥å‘Š
async function downloadCVReport() {
    if (!currentCVTaskId) {
        alert('è¯·å…ˆå®Œæˆä¸€ä¸ªéªŒè¯ä»»åŠ¡');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/cross-validation/download/${currentCVTaskId}/report`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cross_validation_report_${currentCVTaskId}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
        } else {
            alert('ä¸‹è½½å¤±è´¥');
        }
        
    } catch (error) {
        alert(`ä¸‹è½½å¤±è´¥: ${error.message}`);
    }
}

// ä¸‹è½½éªŒè¯å›¾è¡¨
async function downloadCVPlots() {
    if (!currentCVTaskId) {
        alert('è¯·å…ˆå®Œæˆä¸€ä¸ªéªŒè¯ä»»åŠ¡');
        return;
    }
    
    try {
        const response = await fetch(`/api/v1/cross-validation/download/${currentCVTaskId}/plots`);
        
        if (response.ok) {
            const plotsInfo = await response.json();
            alert(`å›¾è¡¨ä¿¡æ¯: ${JSON.stringify(plotsInfo, null, 2)}`);
        } else {
            alert('è·å–å›¾è¡¨ä¿¡æ¯å¤±è´¥');
        }
        
    } catch (error) {
        alert(`è·å–å›¾è¡¨ä¿¡æ¯å¤±è´¥: ${error.message}`);
    }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    const today = new Date();
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    
    document.getElementById('cvStartDate').value = lastMonth.toISOString().split('T')[0];
    document.getElementById('cvEndDate').value = today.toISOString().split('T')[0];
});
</script>

