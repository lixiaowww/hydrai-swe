<!-- æ´ªæ°´é¢„è­¦é¢æ¿ -->
<div class="flood-warning-panel" id="floodWarningPanel" style="display: none;">
    <div class="panel-header">
        <h3>ğŸŒŠ æ´ªæ°´é¢„è­¦ç³»ç»Ÿ</h3>
        <button class="close-btn" onclick="toggleFloodWarningPanel()">Ã—</button>
    </div>
    
    <div class="panel-content">
        <!-- ç«™ç‚¹é€‰æ‹© -->
        <div class="form-group">
            <label for="stationSelect">é€‰æ‹©æ°´æ–‡ç«™ç‚¹:</label>
            <select id="stationSelect" onchange="updateStationInfo()">
                <option value="05OC001">05OC001 - Red River at Emerson</option>
                <option value="05OC011">05OC011 - Red River at Winnipeg</option>
                <option value="05OC012">05OC012 - Red River at Lockport</option>
            </select>
        </div>
        
        <!-- å½“å‰æµé‡è¾“å…¥ -->
        <div class="form-group">
            <label for="currentFlow">å½“å‰æµé‡ (mÂ³/s):</label>
            <input type="number" id="currentFlow" value="150" step="0.1" min="0">
        </div>
        
        <!-- é¢„æµ‹æµé‡è¾“å…¥ -->
        <div class="form-group">
            <label>é¢„æµ‹æµé‡ (mÂ³/s):</label>
            <div class="forecast-inputs">
                <div class="forecast-row">
                    <span>6å°æ—¶:</span>
                    <input type="number" id="forecast6h" value="160" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>12å°æ—¶:</span>
                    <input type="number" id="forecast12h" value="180" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>18å°æ—¶:</span>
                    <input type="number" id="forecast18h" value="220" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>24å°æ—¶:</span>
                    <input type="number" id="forecast24h" value="280" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>30å°æ—¶:</span>
                    <input type="number" id="forecast30h" value="320" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>36å°æ—¶:</span>
                    <input type="number" id="forecast42h" value="280" step="0.1" min="0">
                </div>
                <div class="forecast-row">
                    <span>42å°æ—¶:</span>
                    <input type="number" id="forecast42h" value="220" step="0.1" min="0">
                </div>
            </div>
        </div>
        
        <!-- é£é™©è¯„ä¼°æŒ‰é’® -->
        <div class="form-group">
            <button class="btn btn-primary" onclick="assessFloodRisk()">
                ğŸ” è¯„ä¼°æ´ªæ°´é£é™©
            </button>
        </div>
        
        <!-- é£é™©è¯„ä¼°ç»“æœ -->
        <div id="riskAssessmentResult" class="risk-result" style="display: none;">
            <div class="risk-header">
                <h4>é£é™©è¯„ä¼°ç»“æœ</h4>
                <div class="risk-level" id="riskLevelDisplay"></div>
            </div>
            
            <div class="risk-details">
                <div class="risk-metric">
                    <span class="label">é£é™©ç­‰çº§:</span>
                    <span class="value" id="riskLevel"></span>
                </div>
                <div class="risk-metric">
                    <span class="label">é£é™©è¯„åˆ†:</span>
                    <span class="value" id="riskScore"></span>
                </div>
                <div class="risk-metric">
                    <span class="label">é£é™©æ¦‚ç‡:</span>
                    <span class="value" id="riskProbability"></span>
                </div>
                <div class="risk-metric">
                    <span class="label">é¢„è­¦çº§åˆ«:</span>
                    <span class="value" id="warningLevel"></span>
                </div>
            </div>
            
            <div class="warning-info">
                <div class="warning-description" id="warningDescription"></div>
                <div class="recommended-action" id="recommendedAction"></div>
            </div>
            
            <div class="forecast-summary">
                <h5>é¢„æµ‹æ‘˜è¦</h5>
                <div class="summary-item">
                    <span class="label">å³°å€¼æµé‡:</span>
                    <span class="value" id="peakFlow"></span>
                </div>
                <div class="summary-item">
                    <span class="label">å³°å€¼æ—¶é—´:</span>
                    <span class="value" id="peakTime"></span>
                </div>
                <div class="summary-item">
                    <span class="label">è¶…é˜ˆå€¼æŒç»­æ—¶é—´:</span>
                    <span class="value" id="durationAboveThreshold"></span>
                </div>
            </div>
        </div>
        
        <!-- å†å²é£é™©è¯„ä¼° -->
        <div class="history-section">
            <h5>å†å²é£é™©è¯„ä¼°</h5>
            <div id="riskHistory" class="risk-history">
                <!-- åŠ¨æ€åŠ è½½å†å²è®°å½• -->
            </div>
        </div>
    </div>
</div>

<!-- æ´ªæ°´é¢„è­¦æ ·å¼ -->
<style>
.flood-warning-panel {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.panel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.panel-header h3 {
    margin: 0;
    color: var(--text-color);
}

.close-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--text-color);
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-btn:hover {
    color: var(--accent-color);
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--text-color);
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--input-bg);
    color: var(--text-color);
}

.forecast-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}

.forecast-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.forecast-row span {
    min-width: 60px;
    font-size: 14px;
    color: var(--text-color);
}

.forecast-row input {
    flex: 1;
    min-width: 80px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background: var(--accent-hover);
}

.risk-result {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    background: var(--card-bg);
}

.risk-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border-color);
}

.risk-header h4 {
    margin: 0;
    color: var(--text-color);
}

.risk-level {
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
    text-transform: uppercase;
}

.risk-level.minimal { background: #10B981; color: white; }
.risk-level.low { background: #3B82F6; color: white; }
.risk-level.medium { background: #F59E0B; color: white; }
.risk-level.high { background: #EF4444; color: white; }
.risk-level.extreme { background: #7C2D12; color: white; }

.risk-details {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
}

.risk-metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
}

.risk-metric .label {
    font-weight: 600;
    color: var(--text-color);
}

.risk-metric .value {
    color: var(--accent-color);
    font-weight: 600;
}

.warning-info {
    margin-bottom: 20px;
    padding: 15px;
    background: var(--warning-bg);
    border-radius: 6px;
    border-left: 4px solid var(--warning-color);
}

.warning-description {
    font-weight: 600;
    margin-bottom: 10px;
    color: var(--warning-text);
}

.recommended-action {
    color: var(--warning-text);
    line-height: 1.5;
}

.forecast-summary {
    margin-bottom: 20px;
}

.forecast-summary h5 {
    margin: 0 0 15px 0;
    color: var(--text-color);
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border-color);
}

.summary-item:last-child {
    border-bottom: none;
}

.summary-item .label {
    font-weight: 600;
    color: var(--text-color);
}

.summary-item .value {
    color: var(--accent-color);
    font-weight: 600;
}

.history-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid var(--border-color);
}

.history-section h5 {
    margin: 0 0 15px 0;
    color: var(--text-color);
}

.risk-history {
    max-height: 200px;
    overflow-y: auto;
}

.history-item {
    padding: 10px;
    margin-bottom: 10px;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    background: var(--card-bg);
}

.history-item .time {
    font-size: 12px;
    color: var(--muted-color);
    margin-bottom: 5px;
}

.history-item .risk {
    font-weight: 600;
    color: var(--text-color);
}

/* æ·±è‰²æ¨¡å¼é€‚é… */
body.dark .flood-warning-panel {
    background: #1e293b;
    border-color: #475569;
}

body.dark .form-group input,
body.dark .form-group select {
    background: #334155;
    border-color: #64748b;
    color: #f1f5f9;
}

body.dark .risk-result {
    background: #1e293b;
    border-color: #475569;
}

body.dark .warning-info {
    background: #7c2d12;
    border-left-color: #f97316;
}

body.dark .warning-description,
body.dark .recommended-action {
    color: #fed7aa;
}

body.dark .history-item {
    background: #1e293b;
    border-color: #475569;
}
</style>

<!-- æ´ªæ°´é¢„è­¦JavaScript -->
<script>
// æ´ªæ°´é¢„è­¦é¢æ¿åˆ‡æ¢
function toggleFloodWarningPanel() {
    const panel = document.getElementById('floodWarningPanel');
    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        loadRiskHistory();
    } else {
        panel.style.display = 'none';
    }
}

// æ›´æ–°ç«™ç‚¹ä¿¡æ¯
function updateStationInfo() {
    const stationId = document.getElementById('stationSelect').value;
    // è¿™é‡Œå¯ä»¥æ ¹æ®ç«™ç‚¹IDåŠ è½½ç›¸åº”çš„é…ç½®ä¿¡æ¯
    console.log(`Selected station: ${stationId}`);
}

// è¯„ä¼°æ´ªæ°´é£é™©
async function assessFloodRisk() {
    const stationId = document.getElementById('stationSelect').value;
    const currentFlow = parseFloat(document.getElementById('currentFlow').value);
    
    // æ”¶é›†é¢„æµ‹æµé‡
    const forecastFlows = [
        parseFloat(document.getElementById('forecast6h').value),
        parseFloat(document.getElementById('forecast12h').value),
        parseFloat(document.getElementById('forecast18h').value),
        parseFloat(document.getElementById('forecast24h').value),
        parseFloat(document.getElementById('forecast30h').value),
        parseFloat(document.getElementById('forecast42h').value),
        parseFloat(document.getElementById('forecast42h').value)
    ];
    
    const forecastHours = [6, 12, 18, 24, 30, 36, 42];
    
    try {
        // è°ƒç”¨æ´ªæ°´é£é™©è¯„ä¼°API
        const response = await fetch(`/api/v1/flood/flood-risk-assessment?station_id=${stationId}&current_flow=${currentFlow}&forecast_hours=${forecastHours.join(',')}&forecast_flows=${forecastFlows.join(',')}`);
        
        if (response.ok) {
            const result = await response.json();
            displayRiskAssessment(result);
            saveRiskHistory(result);
        } else {
            const error = await response.json();
            alert(`é£é™©è¯„ä¼°å¤±è´¥: ${error.detail}`);
        }
    } catch (error) {
        console.error('é£é™©è¯„ä¼°è¯·æ±‚å¤±è´¥:', error);
        alert('é£é™©è¯„ä¼°è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// æ˜¾ç¤ºé£é™©è¯„ä¼°ç»“æœ
function displayRiskAssessment(result) {
    const resultDiv = document.getElementById('riskAssessmentResult');
    resultDiv.style.display = 'block';
    
    // æ›´æ–°é£é™©ç­‰çº§æ˜¾ç¤º
    document.getElementById('riskLevel').textContent = result.risk_level;
    document.getElementById('riskScore').textContent = result.risk_score;
    document.getElementById('riskProbability').textContent = `${(result.risk_probability * 100).toFixed(1)}%`;
    document.getElementById('warningLevel').textContent = result.warning_level;
    document.getElementById('warningDescription').textContent = result.warning_description;
    document.getElementById('recommendedAction').textContent = result.recommended_action;
    
    // æ›´æ–°é¢„æµ‹æ‘˜è¦
    document.getElementById('peakFlow').textContent = `${result.forecast_summary.peak_flow} mÂ³/s`;
    document.getElementById('peakTime').textContent = `${result.forecast_summary.peak_flow_time} å°æ—¶`;
    document.getElementById('durationAboveThreshold').textContent = `${result.forecast_summary.duration_above_threshold} å°æ—¶`;
    
    // æ›´æ–°é£é™©ç­‰çº§æ˜¾ç¤ºæ ·å¼
    const riskLevelDisplay = document.getElementById('riskLevelDisplay');
    riskLevelDisplay.textContent = result.risk_level.toUpperCase();
    riskLevelDisplay.className = `risk-level ${result.risk_level}`;
}

// ä¿å­˜é£é™©è¯„ä¼°å†å²
function saveRiskHistory(result) {
    const history = JSON.parse(localStorage.getItem('floodRiskHistory') || '[]');
    const historyItem = {
        time: new Date().toLocaleString(),
        station: result.station_name,
        riskLevel: result.risk_level,
        riskScore: result.risk_score,
        currentFlow: result.current_flow
    };
    
    history.unshift(historyItem);
    
    // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
    if (history.length > 20) {
        history.pop();
    }
    
    localStorage.setItem('floodRiskHistory', JSON.stringify(history));
    loadRiskHistory();
}

// åŠ è½½é£é™©è¯„ä¼°å†å²
function loadRiskHistory() {
    const history = JSON.parse(localStorage.getItem('floodRiskHistory') || '[]');
    const historyDiv = document.getElementById('riskHistory');
    
    if (history.length === 0) {
        historyDiv.innerHTML = '<p class="muted">æš‚æ— å†å²è®°å½•</p>';
        return;
    }
    
    historyDiv.innerHTML = history.map(item => `
        <div class="history-item">
            <div class="time">${item.time}</div>
            <div class="risk">${item.station} - ${item.riskLevel} (${item.riskScore}åˆ†)</div>
        </div>
    `).join('');
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–ç«™ç‚¹ä¿¡æ¯
    updateStationInfo();
});
</script>
