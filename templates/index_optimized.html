<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HydrAI-SWE Demo</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f8fafc;
    }
    
    .container {
      display: flex;
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .left-panel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .control-panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chart-container {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .analysis-panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .glossary-panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .provenance-panel {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      color: #333;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    
    .form-group small {
      color: #6b7280;
      font-size: 12px;
      margin-top: 4px;
      display: block;
    }
    
    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background-color 0.3s ease;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    button.secondary {
      background: #6c757d;
    }
    
    button.secondary:hover {
      background: #545b62;
    }
    
    .toolbar {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .toolbar button {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .muted {
      color: #6b7280;
      font-style: italic;
    }
    
    .glossary-item {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .glossary-term {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }
    
    .glossary-acronym {
      color: #007bff;
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .glossary-definition {
      color: #555;
      line-height: 1.5;
    }
    
    .provenance-item {
      margin-bottom: 15px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }
    
    .provenance-item strong {
      color: #333;
      display: block;
      margin-bottom: 5px;
    }
    
    .provenance-item span {
      color: #555;
      line-height: 1.4;
    }
    
    .status-info {
      background: #e9ecef;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
    }
    
    .status-info p {
      margin: 5px 0;
      color: #495057;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      
      .left-panel,
      .right-panel {
        flex: none;
      }
    }
    
    /* æ·±è‰²æ¨¡å¼ */
    .dark-mode {
      background-color: #1a1a1a;
      color: #ffffff;
    }
    
    .dark-mode .control-panel,
    .dark-mode .chart-container,
    .dark-mode .analysis-panel,
    .dark-mode .glossary-panel,
    .dark-mode .provenance-panel {
      background: #2d2d2d;
      border-color: #444;
      color: #ffffff;
    }
    
    .dark-mode input,
    .dark-mode select {
      background: #3d3d3d;
      border-color: #555;
      color: #ffffff;
    }
    
    .dark-mode .glossary-item,
    .dark-mode .provenance-item {
      background: #3d3d3d;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left-panel">
      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="control-panel">
        <h2>ğŸŒ¨ï¸ HydrAI-SWE å¾„æµé¢„æµ‹ç³»ç»Ÿ</h2>
        
        <div class="form-group">
          <label for="mode">é¢„æµ‹æ¨¡å¼</label>
          <select id="mode" onchange="updateDateFields()">
            <option value="nowcast">å®æ—¶é¢„æµ‹ (Nowcast)</option>
            <option value="scenario">æƒ…æ™¯æ¨¡æ‹Ÿ (Scenario)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="scenarioYear">æƒ…æ™¯å¹´ä»½</label>
          <input type="number" id="scenarioYear" value="2024" min="1979" max="2024">
          <select id="dataRangeSelector" onchange="updateScenarioYearRange()" style="margin-left: 8px; padding: 4px 8px;">
            <option value="auto">Auto-select (Recommended)</option>
            <option value="historical">Historical Depth Priority (1979-1998)</option>
            <option value="recent">Recent Accuracy Priority (2020-2024)</option>
            <option value="mixed">Mixed Use (1979-2024)</option>
          </select>
          <small id="dataRangeHint" style="display: block; margin-top: 4px; color: #6b7280;"></small>
        </div>
        
        <div class="form-group">
          <label for="start">å¼€å§‹æ—¥æœŸ</label>
          <input type="date" id="start">
          <small id="startDateHint">YYYY-MM-DD format for future predictions</small>
        </div>
        
        <div class="form-group">
          <label for="end">ç»“æŸæ—¥æœŸ</label>
          <input type="date" id="end">
          <small id="endDateHint">YYYY-MM-DD format for future predictions</small>
        </div>
        
        <button onclick="fetchForecast(event)">è·å–é¢„æµ‹</button>
        <button onclick="toggleDarkMode()" style="margin-left: 10px; padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">ğŸŒ™ æ·±è‰²æ¨¡å¼</button>
        <button onclick="exportPNG()">Export PNG</button>
        <button onclick="toggleZoom()" class="secondary">Toggle Zoom</button>
        <button onclick="resetZoom()" class="secondary">Reset Zoom</button>
        <button onclick="toggleFloodWarningPanel()" class="secondary">ğŸŒŠ æ´ªæ°´é¢„è­¦</button>
        <button onclick="showCrossValidationPanel()" class="secondary">ğŸ” äº¤å‰éªŒè¯</button>
      </div>
      
      <!-- å›¾è¡¨åŒºåŸŸ -->
      <div class="chart-container">
        <h3>é¢„æµ‹ç»“æœå›¾è¡¨</h3>
        <canvas id="forecastChart" width="800" height="400"></canvas>
        <div class="toolbar">
          <button onclick="exportPNG()">Export PNG</button>
          <button onclick="toggleZoom()" class="secondary">Toggle Zoom</button>
          <button onclick="resetZoom()" class="secondary">Reset Zoom</button>
        </div>
      </div>
      
      <!-- åˆ†æé¢æ¿ -->
      <div class="analysis-panel">
        <h3>åˆ†æç»“æœ</h3>
        <div id="analysisContent">
          <p class="muted">è¯·å…ˆè·å–é¢„æµ‹æ•°æ®ä»¥æŸ¥çœ‹åˆ†æç»“æœ</p>
        </div>
      </div>
      
      <!-- é‡ç‚¹åè¯è§£é‡Š -->
      <div class="glossary-panel">
        <h3>é‡ç‚¹åè¯è§£é‡Š</h3>
        
        <div class="glossary-item">
          <div class="glossary-term">SWE (Snow Water Equivalent)</div>
          <div class="glossary-acronym">ç§¯é›ªæ°´å½“é‡</div>
          <div class="glossary-definition">ç§¯é›ªèåŒ–åäº§ç”Ÿçš„æ°´çš„æ·±åº¦ï¼Œæ˜¯ç§¯é›ªä½“ç§¯å’Œå¯†åº¦çš„ä¹˜ç§¯ã€‚è¿™æ˜¯é‡åŒ–ç§¯é›ªèµ„æºçš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œä¼˜äºå•çº¯çš„ç§¯é›ªæ·±åº¦æµ‹é‡ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">NDSI (Normalized Difference Snow Index)</div>
          <div class="glossary-acronym">æ ‡å‡†åŒ–ç§¯é›ªæŒ‡æ•°</div>
          <div class="glossary-definition">åŸºäºå«æ˜Ÿé¥æ„Ÿæ•°æ®çš„ç§¯é›ªæ£€æµ‹æŒ‡æ•°ï¼Œåˆ©ç”¨ç§¯é›ªåœ¨å¯è§å…‰å’Œè¿‘çº¢å¤–æ³¢æ®µçš„åå°„ç‰¹æ€§å·®å¼‚æ¥è®¡ç®—ï¼Œæ˜¯ç§¯é›ªè¦†ç›–ç›‘æµ‹çš„é‡è¦æŒ‡æ ‡ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">Sentinel-2</div>
          <div class="glossary-acronym">æ¬§æ´²èˆªå¤©å±€é«˜åˆ†è¾¨ç‡å«æ˜Ÿ</div>
          <div class="glossary-definition">æ¬§æ´²èˆªå¤©å±€çš„åœ°çƒè§‚æµ‹å«æ˜Ÿï¼Œæä¾›10ç±³åˆ†è¾¨ç‡çš„å¤šå…‰è°±æ•°æ®ï¼Œç‰¹åˆ«é€‚ç”¨äºç§¯é›ªç›‘æµ‹ã€æ¤è¢«åˆ†æå’Œç¯å¢ƒå˜åŒ–ç ”ç©¶ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">LiDAR</div>
          <div class="glossary-acronym">æ¿€å…‰é›·è¾¾åœ°å½¢æµ‹é‡</div>
          <div class="glossary-definition">ä½¿ç”¨æ¿€å…‰è„‰å†²æµ‹é‡è·ç¦»çš„æŠ€æœ¯ï¼Œèƒ½å¤Ÿç”Ÿæˆé«˜ç²¾åº¦çš„ä¸‰ç»´åœ°å½¢æ¨¡å‹ï¼Œä¸ºç§¯é›ªæ·±åº¦ä¼°ç®—å’Œæ°´æ–‡å»ºæ¨¡æä¾›ç²¾ç¡®çš„åœ°å½¢æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">DEM (Digital Elevation Model)</div>
          <div class="glossary-acronym">æ•°å­—é«˜ç¨‹æ¨¡å‹</div>
          <div class="glossary-definition">è¡¨ç¤ºåœ°çƒè¡¨é¢é«˜ç¨‹çš„æ•°å­—æ¨¡å‹ï¼ŒåŒ…å«åœ°å½¢ä¿¡æ¯å¦‚å¡åº¦ã€å¡å‘å’Œæµå‘ï¼Œæ˜¯æ°´æ–‡å»ºæ¨¡å’Œç§¯é›ªåˆ†å¸ƒåˆ†æçš„åŸºç¡€æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">HYDAT</div>
          <div class="glossary-acronym">åŠ æ‹¿å¤§æ°´æ–‡æ•°æ®åº“</div>
          <div class="glossary-definition">åŠ æ‹¿å¤§æ”¿åºœç»´æŠ¤çš„å›½å®¶æ°´æ–‡æ•°æ®åº“ï¼ŒåŒ…å«æ²³æµæµé‡ã€æ°´ä½ã€æ°´è´¨ç­‰å†å²è§‚æµ‹æ•°æ®ï¼Œä¸ºæ°´æ–‡å»ºæ¨¡å’Œé¢„æµ‹æä¾›åŸºç¡€æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">ECCC</div>
          <div class="glossary-acronym">åŠ æ‹¿å¤§ç¯å¢ƒä¸æ°”å€™å˜åŒ–éƒ¨</div>
          <div class="glossary-definition">è´Ÿè´£åŠ æ‹¿å¤§ç¯å¢ƒæ”¿ç­–å’Œæ°”å€™ç›‘æµ‹çš„æ”¿åºœéƒ¨é—¨ï¼Œæä¾›å¤©æ°”æ•°æ®ã€æ°”å€™ä¿¡æ¯å’Œç¯å¢ƒç›‘æµ‹æœåŠ¡ï¼Œæ˜¯é‡è¦çš„æ°”è±¡æ•°æ®æºã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">å¾„æµé¢„æµ‹</div>
          <div class="glossary-acronym">Runoff Prediction</div>
          <div class="glossary-definition">åŸºäºç§¯é›ªçŠ¶æ€ã€åœ°å½¢ç‰¹å¾å’Œæ°”è±¡æ¡ä»¶ï¼Œé¢„æµ‹æœªæ¥ä¸€æ®µæ—¶é—´å†…æ²³æµçš„æµé‡å˜åŒ–ï¼Œä¸ºæ°´èµ„æºç®¡ç†ã€æ´ªæ°´é¢„è­¦å’Œæ°´ç”µè¿è¥æä¾›å†³ç­–æ”¯æŒã€‚</div>
        </div>
      </div>
    </div>
    
    <!-- æ´ªæ°´é¢„è­¦é¢æ¿ -->
    <div id="floodWarningPanelContainer"></div>
    
    <!-- äº¤å‰éªŒè¯é¢æ¿ -->
    <div id="crossValidationPanelContainer"></div>
    
    <!-- å³ä¾§é¢æ¿ï¼šProvenance & Notes -->
    <div class="right-panel">
      <div class="provenance-panel">
        <h3>æ•°æ®æ¥æºä¸ç®—æ³•ä¿¡æ¯</h3>
        
        <div class="provenance-item">
          <strong>æ•°æ®æ¥æº</strong>
          <span>ECCCç§¯é›ªæ•°æ® + HYDATå¾„æµæ•°æ® + NASA MODISç§¯é›ªè¦†ç›–</span>
        </div>
        
        <div class="provenance-item">
          <strong>ç®—æ³•</strong>
          <span>NeuralHydrology LSTMæ·±åº¦å­¦ä¹ æ¨¡å‹</span>
        </div>
        
        <div class="provenance-item">
          <strong>ä½œè€…</strong>
          <span>Sean Li</span>
        </div>
        
        <div class="provenance-item">
          <strong>ç½®ä¿¡åº¦</strong>
          <span>85% (åŸºäºå†å²æ•°æ®éªŒè¯)</span>
        </div>
        
        <div class="provenance-item">
          <strong>è”ç³»é‚®ç®±</strong>
          <span>
            lixiaowww@gmail.com<br>
            li-x55@webmail.uwinnipeg.ca
          </span>
        </div>
        
        <div class="provenance-item">
          <strong>ç”Ÿæˆæ—¶é—´</strong>
          <span id="dataUpdateTime">åŠ è½½ä¸­...</span>
        </div>
        
        <div class="provenance-item">
          <strong>æ¨¡å¼æ ‡ç­¾</strong>
          <span id="modeTag">æœªé€‰æ‹©</span>
        </div>
        
        <div class="provenance-item">
          <strong>æ€»ç»“</strong>
          <span id="summaryLine">HydrAI-SWEç³»ç»Ÿï¼šåŸºäºæ·±åº¦å­¦ä¹ çš„ç§¯é›ªæ°´å½“é‡ä¸å¾„æµé¢„æµ‹å¹³å°ï¼Œé›†æˆå¤šæºæ•°æ®ï¼Œä¸ºæ°´èµ„æºç®¡ç†æä¾›ç§‘å­¦å†³ç­–æ”¯æŒã€‚</span>
        </div>
      </div>
    </div>
  </div>

  <!-- åŠ è½½å¤–éƒ¨é¢æ¿ -->
  <script>
    // åŠ è½½æ´ªæ°´é¢„è­¦é¢æ¿
    function loadFloodWarningPanel() {
      fetch('templates/flood_warning.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('floodWarningPanelContainer').innerHTML = html;
        })
        .catch(error => {
          console.error('åŠ è½½æ´ªæ°´é¢„è­¦é¢æ¿å¤±è´¥:', error);
        });
    }
    
    // åŠ è½½äº¤å‰éªŒè¯é¢æ¿
    function loadCrossValidationPanel() {
      fetch('templates/cross_validation.html')
        .then(response => response.text())
        .then(html => {
          document.getElementById('crossValidationPanelContainer').innerHTML = html;
        })
        .catch(error => {
          console.error('åŠ è½½äº¤å‰éªŒè¯é¢æ¿å¤±è´¥:', error);
        });
    }
    
    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // è®¾ç½®é»˜è®¤æ—¥æœŸ
      setDefaultDates();
      
      // åŠ è½½å¤–éƒ¨é¢æ¿
      loadFloodWarningPanel();
      loadCrossValidationPanel();
      
      // æ›´æ–°æ•°æ®æ›´æ–°æ—¶é—´
      updateDataUpdateTime();
      
      // åˆå§‹åŒ–å›¾è¡¨ï¼ˆä½†ä¸è‡ªåŠ¨è·å–æ•°æ®ï¼‰
      try {
        ensureChart();
      } catch (e) {
        console.error('Chart initialization failed:', e);
      }

      // æ·»åŠ æƒ…æ™¯å¹´ä»½å˜åŒ–ç›‘å¬å™¨
      addScenarioYearListener();
    });
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    function setDefaultDates() {
      const today = new Date();
      const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
      
      document.getElementById('start').value = today.toISOString().split('T')[0];
      document.getElementById('end').value = nextWeek.toISOString().split('T')[0];
    }
    
    // æ›´æ–°æ—¥æœŸå­—æ®µæç¤º
    function updateDateFields() {
      const mode = document.getElementById('mode').value;
      const startDate = document.getElementById('start');
      const endDate = document.getElementById('end');
      const startHint = document.getElementById('startDateHint');
      const endHint = document.getElementById('endDateHint');
      
      if (mode === 'scenario') {
        startHint.textContent = 'MM-DD format (year determined by scenario year)';
        endHint.textContent = 'MM-DD format (year determined by scenario year)';
        
        // è®¾ç½®é»˜è®¤æ˜¥å­£èé›ªæ—¥æœŸ
        const scenarioYear = document.getElementById('scenarioYear').value;
        startDate.value = `${scenarioYear}-03-15`;
        endDate.value = `${scenarioYear}-05-15`;
        
        // åœ¨æƒ…æ™¯æ¨¡å¼ä¸‹ï¼Œæ—¥æœŸå­—æ®µåº”è¯¥åªæ˜¾ç¤ºæœˆ-æ—¥ï¼Œä½†å€¼ä¿æŒå®Œæ•´æ ¼å¼
        startDate.type = 'date';
        endDate.type = 'date';
      } else {
        startHint.textContent = 'YYYY-MM-DD format for future predictions';
        endHint.textContent = 'YYYY-MM-DD format for future predictions';
        
        // è®¾ç½®é»˜è®¤ä¸‹å‘¨æ—¥æœŸ
        const today = new Date();
        const nextWeek = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
        startDate.value = today.toISOString().split('T')[0];
        endDate.value = nextWeek.toISOString().split('T')[0];
        
        startDate.type = 'date';
        endDate.type = 'date';
      }
      
      updateModeTag();
    }
    
    // æ›´æ–°æƒ…æ™¯å¹´ä»½èŒƒå›´
    function updateScenarioYearRange() {
      const selector = document.getElementById('dataRangeSelector');
      const yearInput = document.getElementById('scenarioYear');
      const hint = document.getElementById('dataRangeHint');
      
      switch (selector.value) {
        case 'historical':
          yearInput.min = '1979';
          yearInput.max = '1998';
          yearInput.value = '1990';
          hint.textContent = 'ä½¿ç”¨1979-1998å¹´æ·±åº¦å†å²æ•°æ®ï¼Œé€‚åˆé•¿æœŸæ¨¡å¼åˆ†æ';
          break;
        case 'recent':
          yearInput.min = '2020';
          yearInput.max = '2024';
          yearInput.value = '2023';
          hint.textContent = 'ä½¿ç”¨2020-2024å¹´è¿‘æœŸæ•°æ®ï¼Œç²¾åº¦æ›´é«˜ä½†å†å²æ·±åº¦æœ‰é™';
          break;
        case 'mixed':
          yearInput.min = '1979';
          yearInput.max = '2024';
          yearInput.value = '2020';
          hint.textContent = 'æ··åˆä½¿ç”¨1979-2024å¹´æ•°æ®ï¼Œå¹³è¡¡å†å²æ·±åº¦å’Œè¿‘æœŸç²¾åº¦';
          break;
        default: // auto
          yearInput.min = '1979';
          yearInput.max = '2024';
          yearInput.value = '2024';
          hint.textContent = 'è‡ªåŠ¨é€‰æ‹©ï¼šä¼˜å…ˆä½¿ç”¨2020-2024å¹´æ•°æ®ï¼Œå¿…è¦æ—¶è¡¥å……å†å²æ•°æ®';
      }
      
      // å½“æƒ…æ™¯å¹´ä»½æ”¹å˜æ—¶ï¼Œè‡ªåŠ¨æ›´æ–°æ—¥æœŸå­—æ®µ
      updateDateFields();
    }
    
    // æ·»åŠ æƒ…æ™¯å¹´ä»½å˜åŒ–ç›‘å¬å™¨
    function addScenarioYearListener() {
      const yearInput = document.getElementById('scenarioYear');
      if (yearInput) {
        yearInput.addEventListener('change', function() {
          // å¦‚æœå½“å‰æ˜¯æƒ…æ™¯æ¨¡å¼ï¼Œæ›´æ–°æ—¥æœŸå­—æ®µ
          if (document.getElementById('mode').value === 'scenario') {
            updateDateFields();
          }
        });
      }
    }
    
    // æ›´æ–°æ¨¡å¼æ ‡ç­¾
    function updateModeTag() {
      const mode = document.getElementById('mode').value;
      const modeTag = document.getElementById('modeTag');
      
      if (mode === 'scenario') {
        const year = document.getElementById('scenarioYear').value;
        modeTag.textContent = `æƒ…æ™¯æ¨¡æ‹Ÿ (${year}å¹´)`;
      } else {
        modeTag.textContent = 'å®æ—¶é¢„æµ‹';
      }
    }
    
    // æ›´æ–°æ•°æ®æ›´æ–°æ—¶é—´
    function updateDataUpdateTime() {
      const now = new Date();
      const timeString = now.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('dataUpdateTime').textContent = timeString;
    }
    
    // å›¾è¡¨ç›¸å…³å˜é‡
    let chart = null;
    let zoomEnabled = false;
    
    // ç¡®ä¿å›¾è¡¨å·²åˆå§‹åŒ–
    function ensureChart() {
      if (chart) return;
      
      const ctx = document.getElementById('forecastChart');
      if (!ctx) return;
      
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'é¢„æµ‹å¾„æµ (mÂ³/s)',
            data: [],
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            zoom: {
              zoom: {
                wheel: {
                  enabled: false
                },
                pinch: {
                  enabled: false
                },
                mode: 'xy'
              },
              pan: {
                enabled: false
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'æ—¥æœŸ'
              }
            },
            y: {
              title: {
                display: true,
                text: 'å¾„æµ (mÂ³/s)'
              }
            }
          }
        }
      });
    }
    
    // è·å–é¢„æµ‹æ•°æ®
    async function fetchForecast(event) {
      if (event) {
        event.preventDefault();
      }
      
      const mode = document.getElementById('mode').value;
      const startDate = document.getElementById('start').value;
      const endDate = document.getElementById('end').value;
      const scenarioYear = document.getElementById('scenarioYear').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
      }
      
      try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const analysisContent = document.getElementById('analysisContent');
        analysisContent.innerHTML = '<p>æ­£åœ¨è·å–é¢„æµ‹æ•°æ®...</p>';
        
        // æ„å»ºAPIè¯·æ±‚å‚æ•°
        const params = new URLSearchParams({
          station_id: '05OC001',
          start_date: startDate,
          end_date: endDate,
          mode: mode
        });
        
        if (mode === 'scenario') {
          params.append('scenario_year', scenarioYear);
        }
        
        const response = await fetch(`/api/v1/runoff-forecast?${params}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.forecasts && data.forecasts.length > 0) {
          // æ›´æ–°å›¾è¡¨
          updateChart(data.forecasts);
          
          // æ›´æ–°åˆ†æç»“æœ
          updateAnalysis(data.forecasts);
          
          // æ›´æ–°æ¨¡å¼æ ‡ç­¾
          updateModeTag();
          
          // æ›´æ–°æ•°æ®æ›´æ–°æ—¶é—´
          updateDataUpdateTime();
          
          console.log('é¢„æµ‹æ•°æ®è·å–æˆåŠŸ:', data);
        } else {
          throw new Error('APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }
        
      } catch (error) {
        console.error('è·å–é¢„æµ‹æ•°æ®å¤±è´¥:', error);
        const analysisContent = document.getElementById('analysisContent');
        analysisContent.innerHTML = `<p style="color: red;">è·å–é¢„æµ‹æ•°æ®å¤±è´¥: ${error.message}</p>`;
      }
    }
    
    // æ›´æ–°å›¾è¡¨
    function updateChart(forecasts) {
      if (!chart) {
        ensureChart();
      }
      
      const labels = forecasts.map(f => f.date);
      const data = forecasts.map(f => f.streamflow_m3s ?? f.predicted_flow ?? 0);
      
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }
    
    // æ›´æ–°åˆ†æç»“æœ
    function updateAnalysis(forecasts) {
      if (!forecasts || forecasts.length === 0) return;
      
      const flows = forecasts.map(f => f.streamflow_m3s);
      const dates = forecasts.map(f => new Date(f.date));
      
      // è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡
      const minFlow = Math.min(...flows);
      const maxFlow = Math.max(...flows);
      const meanFlow = flows.reduce((a, b) => a + b, 0) / flows.length;
      
      // è®¡ç®—è¶‹åŠ¿ï¼ˆç®€å•çº¿æ€§å›å½’æ–œç‡ï¼‰
      const n = flows.length;
      const xMean = (n - 1) / 2;
      const yMean = meanFlow;
      let numerator = 0;
      let denominator = 0;
      
      for (let i = 0; i < n; i++) {
        numerator += (i - xMean) * (flows[i] - yMean);
        denominator += (i - xMean) * (i - xMean);
      }
      
      const slope = denominator !== 0 ? numerator / denominator : 0;
      const trend = slope > 0 ? 'ä¸Šå‡' : slope < 0 ? 'ä¸‹é™' : 'ç¨³å®š';
      
      // è®¡ç®—æ ‡å‡†å·®
      const variance = flows.reduce((acc, val) => acc + Math.pow(val - meanFlow, 2), 0) / n;
      const stdDev = Math.sqrt(variance);
      
      // è®¡ç®—ç™¾åˆ†ä½æ•°
      const sortedFlows = [...flows].sort((a, b) => a - b);
      const p10 = sortedFlows[Math.floor(n * 0.1)];
      const p50 = sortedFlows[Math.floor(n * 0.5)];
      const p90 = sortedFlows[Math.floor(n * 0.9)];
      
      // æ‰¾å‡ºå³°å€¼
      const peakIndex = flows.indexOf(maxFlow);
      const peakDate = dates[peakIndex];
      
      // è®¡ç®—è¶…è¿‡é˜ˆå€¼çš„æ¬¡æ•°
      const threshold = meanFlow * 1.5; // 1.5å€å‡å€¼ä½œä¸ºé˜ˆå€¼
      const exceedCount = flows.filter(f => f > threshold).length;
      
      const analysisContent = document.getElementById('analysisContent');
      analysisContent.innerHTML = `
        <div class="status-info">
          <h4>ğŸ“Š ç»Ÿè®¡æ‘˜è¦</h4>
          <p><strong>æœ€å°å€¼:</strong> ${minFlow.toFixed(2)} mÂ³/s</p>
          <p><strong>æœ€å¤§å€¼:</strong> ${maxFlow.toFixed(2)} mÂ³/s</p>
          <p><strong>å¹³å‡å€¼:</strong> ${meanFlow.toFixed(2)} mÂ³/s</p>
          
          <h4>ğŸ“ˆ è¶‹åŠ¿åˆ†æ</h4>
          <p><strong>è¶‹åŠ¿:</strong> ${trend} (æ–œç‡: ${slope.toFixed(4)})</p>
          <p><strong>ç¦»æ•£åº¦:</strong> æ ‡å‡†å·® ${stdDev.toFixed(2)} mÂ³/s</p>
          
          <h4>ğŸ“Š ç™¾åˆ†ä½æ•°</h4>
          <p><strong>P10:</strong> ${p10.toFixed(2)} mÂ³/s</p>
          <p><strong>P50 (ä¸­ä½æ•°):</strong> ${p50.toFixed(2)} mÂ³/s</p>
          <p><strong>P90:</strong> ${p90.toFixed(2)} mÂ³/s</p>
          
          <h4>ğŸ”ï¸ å³°å€¼åˆ†æ</h4>
          <p><strong>å³°å€¼æµé‡:</strong> ${maxFlow.toFixed(2)} mÂ³/s</p>
          <p><strong>å³°å€¼æ—¥æœŸ:</strong> ${peakDate.toLocaleDateString('zh-CN')}</p>
          <p><strong>è¶…è¿‡é˜ˆå€¼æ¬¡æ•°:</strong> ${exceedCount} æ¬¡ (é˜ˆå€¼: ${threshold.toFixed(2)} mÂ³/s)</p>
        </div>
      `;
    }
    
    // å¯¼å‡ºPNG
    function exportPNG() {
      if (chart) {
        const link = document.createElement('a');
        link.download = 'forecast_chart.png';
        link.href = chart.toBase64Image();
        link.click();
      }
    }
    
    // åˆ‡æ¢ç¼©æ”¾
    function toggleZoom() {
      if (!chart) return;
      
      zoomEnabled = !zoomEnabled;
      chart.options.plugins.zoom.zoom.wheel.enabled = zoomEnabled;
      chart.options.plugins.zoom.zoom.pinch.enabled = zoomEnabled;
      chart.options.plugins.zoom.pan.enabled = zoomEnabled;
      chart.update();
      
      const button = event.target;
      if (zoomEnabled) {
        button.textContent = 'Disable Zoom';
        button.style.background = '#fbbf24';
        button.style.color = '#1f2937';
        button.style.boxShadow = '0 2px 4px rgba(0,0,0,0.3)';
      } else {
        button.textContent = 'Enable Zoom';
        button.style.background = '#6c757d';
        button.style.color = '#ffffff';
        button.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';
      }
    }
    
    // é‡ç½®ç¼©æ”¾
    function resetZoom() {
      if (chart) {
        chart.resetZoom();
      }
    }
    
    // åˆ‡æ¢æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const button = event.target;
      if (document.body.classList.contains('dark-mode')) {
        button.textContent = 'â˜€ï¸ æµ…è‰²æ¨¡å¼';
        button.style.background = '#fbbf24';
        button.style.color = '#1f2937';
      } else {
        button.textContent = 'ğŸŒ™ æ·±è‰²æ¨¡å¼';
        button.style.background = '#6b7280';
        button.style.color = '#ffffff';
      }
    }
    
    // åˆ‡æ¢æ´ªæ°´é¢„è­¦é¢æ¿
    function toggleFloodWarningPanel() {
      const panel = document.getElementById('floodWarningPanel');
      if (panel) {
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    // æ˜¾ç¤ºäº¤å‰éªŒè¯é¢æ¿
    function showCrossValidationPanel() {
      const panel = document.getElementById('crossValidationPanel');
      if (panel) {
        panel.style.display = 'block';
      }
    }
  </script>
  
  <!-- åŠ è½½Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</body>
</html>
