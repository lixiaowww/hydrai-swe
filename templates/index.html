<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HydrAI-SWE Demo</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: #f8fafc;
    }
    
    .container {
      display: flex;
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .left-panel {
      flex: 2;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    .right-panel {
      flex: 1;
      min-width: 300px;
    }
    
    .card { 
      background: white;
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 20px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .main-controls {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
    }
    
    .main-controls h2 {
      margin-top: 0;
      color: white;
    }
    
    .control-group {
      margin-bottom: 16px;
    }
    
    label { 
      display: block; 
      margin-bottom: 6px; 
      font-weight: 600; 
      color: rgba(255,255,255,0.9);
    }
    
    input, select { 
      padding: 10px 12px; 
      width: 100%; 
      box-sizing: border-box; 
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 6px;
      background: rgba(255,255,255,0.1);
      color: white;
      font-size: 14px;
    }
    
    input::placeholder {
      color: rgba(255,255,255,0.7);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: rgba(255,255,255,0.8);
      background: rgba(255,255,255,0.15);
    }
    
    button { 
      margin-top: 16px; 
      padding: 12px 20px; 
      background: rgba(255,255,255,0.2);
      color: white; 
      border: 1px solid rgba(255,255,255,0.3);
      border-radius: 8px; 
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    button:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-1px);
    }
    
    button:disabled { 
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
      transform: none;
    }
    
    .chart-container {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .chart-container h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
    }
    
    .analysis-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .analysis-panel h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
    
    .provenance-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    
    .provenance-panel h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
    
    .provenance-item {
      margin-bottom: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    
    .provenance-item strong {
      color: #1f2937;
      display: block;
      margin-bottom: 4px;
    }
    
    .provenance-item span {
      color: #6b7280;
      font-size: 14px;
    }
    
    .provenance-item a {
      color: #3b82f6;
      text-decoration: none;
    }
    
    .provenance-item a:hover {
      text-decoration: underline;
    }
    
    .glossary-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .glossary-panel h3 {
      margin-top: 0;
      color: #1f2937;
      font-size: 18px;
      border-bottom: 2px solid #e5e7eb;
      padding-bottom: 8px;
    }
    
    .glossary-item {
      margin-bottom: 16px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #10b981;
    }
    
    .glossary-term {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
      font-size: 16px;
    }
    
    .glossary-definition {
      color: #4b5563;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .glossary-acronym {
      color: #6b7280;
      font-size: 12px;
      font-style: italic;
    }
    
    .toolbar { 
      display: flex; 
      gap: 8px; 
      align-items: center; 
      flex-wrap: wrap; 
      margin-top: 16px;
    }
    
    .toolbar button.secondary { 
      background: #6b7280;
      color: white;
      border: none;
    }
    
    .toolbar button.secondary:hover {
      background: #4b5563;
    }
    
    .muted { 
      color: #6b7280; 
      font-size: 14px; 
    }
    
    .small {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
      display: block;
    }
    
    .status {
      margin-top: 16px;
      padding: 12px;
      background: #f0f9ff;
      border: 1px solid #0ea5e9;
      border-radius: 8px;
      color: #0c4a6e;
    }
    
    .status.error {
      background: #fef2f2;
      border-color: #ef4444;
      color: #7f1d1d;
    }
    
    .status.success {
      background: #f0fdf4;
      border-color: #22c55e;
      color: #14532d;
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 16px; 
      font-size: 14px;
    }
    
    th, td { 
      border: 1px solid #e5e7eb; 
      padding: 8px; 
      text-align: left; 
    }
    
    th { 
      background: #f8fafc; 
      font-weight: 600;
      color: #1f2937;
    }
    
    td {
      color: #4b5563;
    }
    
    .dark-mode-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    body.dark { 
      background: #0b1220; 
      color: #e5e7eb; 
    }
    
    body.dark .card,
    body.dark .chart-container,
    body.dark .analysis-panel,
    body.dark .provenance-panel,
    body.dark .glossary-panel {
      background: #1e293b;
      border-color: #334155;
      color: #e5e7eb;
    }
    
    body.dark .provenance-item,
    body.dark .glossary-item {
      background: #334155;
    }
    
    body.dark th {
      background: #334155;
      color: #e5e7eb;
    }
    
    body.dark td {
      color: #cbd5e1;
    }
    
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }
      
      .right-panel {
        min-width: auto;
      }
      
      .dark-mode-toggle {
        position: static;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="dark-mode-toggle">
    <button onclick="toggleDarkMode()" style="padding: 8px 12px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">
      ğŸŒ™ Dark Mode
    </button>
  </div>

  <div class="container">
    <!-- å·¦ä¾§é¢æ¿ï¼šä¸»è¦åŠŸèƒ½åŒºåŸŸ -->
    <div class="left-panel">
      <!-- ä¸»è¦æ§åˆ¶åŒºåŸŸ -->
      <div class="card main-controls">
        <h2>HydrAI-SWE ç§¯é›ªæ°´å½“é‡é¢„æµ‹ç³»ç»Ÿ</h2>
        
        <div class="control-group">
          <label for="mode">é¢„æµ‹æ¨¡å¼</label>
          <select id="mode" onchange="updateScenarioYearRange(); updateDateFields();">
            <option value="nowcast">Nowcast (å®æ—¶é¢„æµ‹)</option>
            <option value="scenario">Scenario (åœºæ™¯åˆ†æ)</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="dataRangeSelector">æ™ºèƒ½æ•°æ®é€‰æ‹©å»ºè®®</label>
          <select id="dataRangeSelector" onchange="updateScenarioYearRange()">
            <option value="historical">Historical Depth Priority (å†å²æ·±åº¦ä¼˜å…ˆ)</option>
            <option value="recent">Recent Accuracy Priority (è¿‘æœŸç²¾åº¦ä¼˜å…ˆ)</option>
            <option value="mixed">Mixed Use (æ··åˆä½¿ç”¨)</option>
            <option value="auto">Auto-select (è‡ªåŠ¨é€‰æ‹©)</option>
          </select>
        </div>
        
        <div class="control-group">
          <label for="scenarioYear">Scenario Year (åœºæ™¯å¹´ä»½)</label>
          <input type="number" id="scenarioYear" min="1979" max="2024" placeholder="1979-2024" value="2023">
          <small>Available historical data: 1979-2024</small>
        </div>
        
        <div class="control-group">
          <label for="start">å¼€å§‹æ—¥æœŸ</label>
          <input type="date" id="start">
          <small id="startDateHint">MM-DD format (year determined by scenario year)</small>
        </div>
        
        <div class="control-group">
          <label for="end">ç»“æŸæ—¥æœŸ</label>
          <input type="date" id="end">
          <small id="endDateHint">MM-DD format (year determined by scenario year)</small>
        </div>
        
        <button onclick="fetchForecast(event)">è·å–é¢„æµ‹</button>
      </div>
      
      <!-- å›¾è¡¨åŒºåŸŸ -->
      <div class="chart-container">
        <h3>é¢„æµ‹ç»“æœå›¾è¡¨</h3>
        <canvas id="forecastChart" width="800" height="400"></canvas>
        <div class="toolbar">
          <button onclick="exportPNG()">Export PNG</button>
          <button onclick="toggleZoom()" class="secondary">Toggle Zoom</button>
          <button onclick="resetZoom()" class="secondary">Reset Zoom</button>
        </div>
      </div>
      
      <!-- åˆ†æé¢æ¿ -->
      <div class="analysis-panel">
        <h3>åˆ†æç»“æœ</h3>
        <div id="analysisContent">
          <p class="muted">è¯·å…ˆè·å–é¢„æµ‹æ•°æ®ä»¥æŸ¥çœ‹åˆ†æç»“æœ</p>
        </div>
      </div>
      
      <!-- é‡ç‚¹åè¯è§£é‡Š -->
      <div class="glossary-panel">
        <h3>é‡ç‚¹åè¯è§£é‡Š</h3>
        
        <div class="glossary-item">
          <div class="glossary-term">SWE (Snow Water Equivalent)</div>
          <div class="glossary-acronym">ç§¯é›ªæ°´å½“é‡</div>
          <div class="glossary-definition">ç§¯é›ªèåŒ–åäº§ç”Ÿçš„æ°´çš„æ·±åº¦ï¼Œæ˜¯ç§¯é›ªä½“ç§¯å’Œå¯†åº¦çš„ä¹˜ç§¯ã€‚è¿™æ˜¯é‡åŒ–ç§¯é›ªèµ„æºçš„æ ¸å¿ƒæŒ‡æ ‡ï¼Œä¼˜äºå•çº¯çš„ç§¯é›ªæ·±åº¦æµ‹é‡ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">NDSI (Normalized Difference Snow Index)</div>
          <div class="glossary-acronym">æ ‡å‡†åŒ–ç§¯é›ªæŒ‡æ•°</div>
          <div class="glossary-definition">åŸºäºå«æ˜Ÿé¥æ„Ÿæ•°æ®çš„ç§¯é›ªæ£€æµ‹æŒ‡æ•°ï¼Œåˆ©ç”¨ç§¯é›ªåœ¨å¯è§å…‰å’Œè¿‘çº¢å¤–æ³¢æ®µçš„åå°„ç‰¹æ€§å·®å¼‚æ¥è®¡ç®—ï¼Œæ˜¯ç§¯é›ªè¦†ç›–ç›‘æµ‹çš„é‡è¦æŒ‡æ ‡ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">Sentinel-2</div>
          <div class="glossary-acronym">æ¬§æ´²èˆªå¤©å±€é«˜åˆ†è¾¨ç‡å«æ˜Ÿ</div>
          <div class="glossary-definition">æ¬§æ´²èˆªå¤©å±€çš„åœ°çƒè§‚æµ‹å«æ˜Ÿï¼Œæä¾›10ç±³åˆ†è¾¨ç‡çš„å¤šå…‰è°±æ•°æ®ï¼Œç‰¹åˆ«é€‚ç”¨äºç§¯é›ªç›‘æµ‹ã€æ¤è¢«åˆ†æå’Œç¯å¢ƒå˜åŒ–ç ”ç©¶ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">LiDAR</div>
          <div class="glossary-acronym">æ¿€å…‰é›·è¾¾åœ°å½¢æµ‹é‡</div>
          <div class="glossary-definition">ä½¿ç”¨æ¿€å…‰è„‰å†²æµ‹é‡è·ç¦»çš„æŠ€æœ¯ï¼Œèƒ½å¤Ÿç”Ÿæˆé«˜ç²¾åº¦çš„ä¸‰ç»´åœ°å½¢æ¨¡å‹ï¼Œä¸ºç§¯é›ªæ·±åº¦ä¼°ç®—å’Œæ°´æ–‡å»ºæ¨¡æä¾›ç²¾ç¡®çš„åœ°å½¢æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">DEM (Digital Elevation Model)</div>
          <div class="glossary-acronym">æ•°å­—é«˜ç¨‹æ¨¡å‹</div>
          <div class="glossary-definition">è¡¨ç¤ºåœ°çƒè¡¨é¢é«˜ç¨‹çš„æ•°å­—æ¨¡å‹ï¼ŒåŒ…å«åœ°å½¢ä¿¡æ¯å¦‚å¡åº¦ã€å¡å‘å’Œæµå‘ï¼Œæ˜¯æ°´æ–‡å»ºæ¨¡å’Œç§¯é›ªåˆ†å¸ƒåˆ†æçš„åŸºç¡€æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">HYDAT</div>
          <div class="glossary-acronym">åŠ æ‹¿å¤§æ°´æ–‡æ•°æ®åº“</div>
          <div class="glossary-definition">åŠ æ‹¿å¤§æ”¿åºœç»´æŠ¤çš„å›½å®¶æ°´æ–‡æ•°æ®åº“ï¼ŒåŒ…å«æ²³æµæµé‡ã€æ°´ä½ã€æ°´è´¨ç­‰å†å²è§‚æµ‹æ•°æ®ï¼Œä¸ºæ°´æ–‡å»ºæ¨¡å’Œé¢„æµ‹æä¾›åŸºç¡€æ•°æ®ã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">ECCC</div>
          <div class="glossary-acronym">åŠ æ‹¿å¤§ç¯å¢ƒä¸æ°”å€™å˜åŒ–éƒ¨</div>
          <div class="glossary-definition">è´Ÿè´£åŠ æ‹¿å¤§ç¯å¢ƒæ”¿ç­–å’Œæ°”å€™ç›‘æµ‹çš„æ”¿åºœéƒ¨é—¨ï¼Œæä¾›å¤©æ°”æ•°æ®ã€æ°”å€™ä¿¡æ¯å’Œç¯å¢ƒç›‘æµ‹æœåŠ¡ï¼Œæ˜¯é‡è¦çš„æ°”è±¡æ•°æ®æºã€‚</div>
        </div>
        
        <div class="glossary-item">
          <div class="glossary-term">å¾„æµé¢„æµ‹</div>
          <div class="glossary-acronym">Runoff Prediction</div>
          <div class="glossary-definition">åŸºäºç§¯é›ªçŠ¶æ€ã€åœ°å½¢ç‰¹å¾å’Œæ°”è±¡æ¡ä»¶ï¼Œé¢„æµ‹æœªæ¥ä¸€æ®µæ—¶é—´å†…æ²³æµçš„æµé‡å˜åŒ–ï¼Œä¸ºæ°´èµ„æºç®¡ç†ã€æ´ªæ°´é¢„è­¦å’Œæ°´ç”µè¿è¥æä¾›å†³ç­–æ”¯æŒã€‚</div>
        </div>
      </div>
    </div>
    
    <!-- å³ä¾§é¢æ¿ï¼šProvenance & Notes -->
    <div class="right-panel">
      <div class="provenance-panel">
        <h3>æ•°æ®æ¥æºä¸ç®—æ³•ä¿¡æ¯</h3>
        
        <div class="provenance-item">
          <strong>æ•°æ®æ¥æº</strong>
          <span>ECCCç§¯é›ªæ•°æ® + HYDATå¾„æµæ•°æ® + NASA MODISç§¯é›ªè¦†ç›–</span>
        </div>
        
        <div class="provenance-item">
          <strong>ç®—æ³•</strong>
          <span>NeuralHydrology LSTMæ·±åº¦å­¦ä¹ æ¨¡å‹</span>
        </div>
        
        <div class="provenance-item">
          <strong>ä½œè€…</strong>
          <span>Sean Li</span>
        </div>
        
        <div class="provenance-item">
          <strong>ç½®ä¿¡åº¦</strong>
          <span>85% (åŸºäºå†å²æ•°æ®éªŒè¯)</span>
        </div>
        
        <div class="provenance-item">
          <strong>è”ç³»é‚®ç®±</strong>
          <span>
            <a href="mailto:lixiaowww@gmail.com">lixiaowww@gmail.com</a><br>
            <a href="mailto:li-x55@webmail.uwinnipeg.ca">li-x55@webmail.uwinnipeg.ca</a>
          </span>
        </div>
        
        <div class="provenance-item">
          <strong>æ•°æ®æ›´æ–°æ—¶é—´</strong>
          <span id="dataUpdateTime">Loading...</span>
        </div>
        
        <div class="provenance-item">
          <strong>æ¨¡å‹ç‰ˆæœ¬</strong>
          <span>v1.0.0 (2024-08-18)</span>
        </div>
        
        <div class="provenance-item">
          <strong>é¢„æµ‹èŒƒå›´</strong>
          <span>1-30å¤©å¾„æµé¢„æµ‹</span>
        </div>
        
        <div class="provenance-item">
          <strong>ç©ºé—´åˆ†è¾¨ç‡</strong>
          <span>500m (çº¢æ²³æµåŸŸ)</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  
  <script>
    // å…¨å±€å˜é‡
    let chart = null;
    let zoomEnabled = false;
    
    // åˆå§‹åŒ–
    window.onload = function() {
      triggerInitialFetch();
      updateDataUpdateTime();
    };
    
    // æ›´æ–°æ•°æ®æ›´æ–°æ—¶é—´
    function updateDataUpdateTime() {
      const now = new Date();
      document.getElementById('dataUpdateTime').textContent = now.toLocaleString();
    }
    
    // åˆ‡æ¢æ·±è‰²æ¨¡å¼
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      const button = document.querySelector('.dark-mode-toggle button');
      if (document.body.classList.contains('dark')) {
        button.textContent = 'â˜€ï¸ Light Mode';
        button.style.background = '#fbbf24';
      } else {
        button.textContent = 'ğŸŒ™ Dark Mode';
        button.style.background = '#6b7280';
      }
    }
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    function setDefaultDates() {
      const mode = document.getElementById('mode').value;
      const startDate = document.getElementById('start');
      const endDate = document.getElementById('end');
      
      if (mode === 'scenario') {
        // Scenarioæ¨¡å¼ï¼šåªæ˜¾ç¤ºæœˆæ—¥ï¼Œå¹´ä»½ç”±scenario yearå†³å®š
        const today = new Date();
        const springStart = new Date(today.getFullYear(), 2, 1); // 3æœˆ1æ—¥
        const springEnd = new Date(today.getFullYear(), 5, 30);  // 6æœˆ30æ—¥
        
        if (!startDate.value) {
          startDate.value = springStart.toISOString().slice(5, 10); // åªå–MM-DD
        }
        if (!endDate.value) {
          endDate.value = springEnd.toISOString().slice(5, 10);   // åªå–MM-DD
        }
      } else {
        // Nowcastæ¨¡å¼ï¼šæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 6);
        
        if (!startDate.value) {
          startDate.value = today.toISOString().slice(0, 10);
        }
        if (!endDate.value) {
          endDate.value = nextWeek.toISOString().slice(0, 10);
        }
      }
    }
    
    // æ›´æ–°æ—¥æœŸå­—æ®µæç¤º
    function updateDateFields() {
      const mode = document.getElementById('mode').value;
      const startDate = document.getElementById('start');
      const endDate = document.getElementById('end');
      const startHint = document.getElementById('startDateHint');
      const endHint = document.getElementById('endDateHint');
      
      if (mode === 'scenario') {
        // Scenarioæ¨¡å¼ï¼šåªæ˜¾ç¤ºæœˆæ—¥ï¼Œå¹´ä»½ç”±scenario yearå†³å®š
        startHint.textContent = 'MM-DD format (year determined by scenario year)';
        endHint.textContent = 'MM-DD format (year determined by scenario year)';
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜¥å­£èé›ªæœŸï¼ˆ3-6æœˆï¼‰
        const today = new Date();
        const springStart = new Date(today.getFullYear(), 2, 1); // 3æœˆ1æ—¥
        const springEnd = new Date(today.getFullYear(), 5, 30);  // 6æœˆ30æ—¥
        
        if (!startDate.value) {
          startDate.value = springStart.toISOString().slice(5, 10); // åªå–MM-DD
        }
        if (!endDate.value) {
          endDate.value = springEnd.toISOString().slice(5, 10);   // åªå–MM-DD
        }
        
      } else {
        // Nowcastæ¨¡å¼ï¼šæ˜¾ç¤ºå®Œæ•´æ—¥æœŸ
        startHint.textContent = 'YYYY-MM-DD format for future predictions';
        endHint.textContent = 'YYYY-MM-DD format for future predictions';
        
        // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæœªæ¥ä¸€å‘¨
        const today = new Date();
        const nextWeek = new Date(today);
        nextWeek.setDate(today.getDate() + 6);
        
        if (!startDate.value) {
          startDate.value = today.toISOString().slice(0, 10);
        }
        if (!endDate.value) {
          endDate.value = nextWeek.toISOString().slice(0, 10);
        }
      }
    }
    
    // æ›´æ–°åœºæ™¯å¹´ä»½èŒƒå›´
    function updateScenarioYearRange() {
      const mode = document.getElementById('mode').value;
      const dataRange = document.getElementById('dataRangeSelector').value;
      const scenarioYear = document.getElementById('scenarioYear');
      
      if (mode === 'scenario') {
        if (dataRange === 'historical') {
          scenarioYear.value = '1985';
          scenarioYear.min = '1979';
          scenarioYear.max = '1995';
        } else if (dataRange === 'recent') {
          scenarioYear.value = '2020';
          scenarioYear.min = '2020';
          scenarioYear.max = '2024';
        } else if (dataRange === 'mixed') {
          scenarioYear.value = '2000';
          scenarioYear.min = '1980';
          scenarioYear.max = '2020';
        } else { // auto
          scenarioYear.value = '2023';
          scenarioYear.min = '1979';
          scenarioYear.max = '2024';
        }
      }
    }
    
    // ç¡®ä¿å›¾è¡¨å­˜åœ¨
    function ensureChart() {
      const canvas = document.getElementById('forecastChart');
      if (!canvas) {
        console.error('Chart canvas not found');
        return;
      }
      
      if (chart) {
        chart.destroy();
      }
      
      const ctx = canvas.getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'é¢„æµ‹å¾„æµ (mÂ³/s)',
            data: [],
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            zoom: {
              zoom: {
                wheel: {
                  enabled: zoomEnabled,
                },
                pinch: {
                  enabled: zoomEnabled,
                },
                mode: 'xy',
              },
              pan: {
                enabled: zoomEnabled,
              },
            },
            legend: {
              position: 'top',
            },
            title: {
              display: true,
              text: 'ç§¯é›ªæ°´å½“é‡å¾„æµé¢„æµ‹'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'å¾„æµ (mÂ³/s)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'æ—¥æœŸ'
              }
            }
          }
        }
      });
    }
    
    // è§¦å‘åˆå§‹è·å–
    function triggerInitialFetch() {
      setTimeout(() => {
        setDefaultDates();
        try {
          ensureChart();
        } catch (e) {
          console.error('Chart initialization failed:', e);
        }
        try {
          fetchForecast({ preventDefault: () => {} });
        } catch (e) {
          console.error('Initial fetch failed:', e);
        }
      }, 100);
    }
    
    // è·å–é¢„æµ‹
    async function fetchForecast(event) {
      if (event) {
        event.preventDefault();
      }
      
      const mode = document.getElementById('mode').value;
      const startDate = document.getElementById('start').value;
      const endDate = document.getElementById('end').value;
      const scenarioYear = document.getElementById('scenarioYear').value;
      
      if (!startDate || !endDate) {
        alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
        return;
      }
      
      // æ˜¾ç¤ºçŠ¶æ€
      const statusDiv = document.querySelector('.status') || createStatusDiv();
      statusDiv.textContent = 'æ­£åœ¨è·å–é¢„æµ‹æ•°æ®...';
      statusDiv.className = 'status';
      
      try {
        // æ„å»ºè¯·æ±‚å‚æ•°
        let requestStartDate = startDate;
        let requestEndDate = endDate;
        
        if (mode === 'scenario') {
          // å¯¹äºscenarioæ¨¡å¼ï¼Œå°†æœˆæ—¥ä¸å¹´ä»½ç»„åˆ
          const startMonthDay = startDate.slice(5); // æå–MM-DD
          const endMonthDay = endDate.slice(5);
          requestStartDate = `${scenarioYear}-${startMonthDay}`;
          requestEndDate = `${scenarioYear}-${endMonthDay}`;
        }
        
        const response = await fetch(`/api/v1/runoff-forecast?start_date=${requestStartDate}&end_date=${requestEndDate}&mode=${mode}&scenario_year=${scenarioYear}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.forecasts && data.forecasts.length > 0) {
          updateChart(data.forecasts);
          updateAnalysisPanel(data);
          updateStatus('é¢„æµ‹æ•°æ®è·å–æˆåŠŸï¼', 'success');
        } else {
          throw new Error('No forecast data received');
        }
        
      } catch (error) {
        console.error('Error fetching forecast:', error);
        updateStatus(`è·å–é¢„æµ‹å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // åˆ›å»ºçŠ¶æ€div
    function createStatusDiv() {
      const statusDiv = document.createElement('div');
      statusDiv.className = 'status';
      document.querySelector('.analysis-panel').appendChild(statusDiv);
      return statusDiv;
    }
    
    // æ›´æ–°çŠ¶æ€
    function updateStatus(message, type) {
      const statusDiv = document.querySelector('.status') || createStatusDiv();
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }
    
    // æ›´æ–°å›¾è¡¨
    function updateChart(forecasts) {
      if (!chart) {
        ensureChart();
      }
      
      const labels = forecasts.map(f => f.date);
      const data = forecasts.map(f => f.predicted_flow);
      
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.update();
    }
    
    // æ›´æ–°åˆ†æé¢æ¿
    function updateAnalysisPanel(data) {
      const analysisContent = document.getElementById('analysisContent');
      
      if (!data.forecasts || data.forecasts.length === 0) {
        analysisContent.innerHTML = '<p class="muted">æ— åˆ†ææ•°æ®</p>';
        return;
      }
      
      const forecasts = data.forecasts;
      const flows = forecasts.map(f => f.predicted_flow);
      
      // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
      const avgFlow = flows.reduce((a, b) => a + b, 0) / flows.length;
      const maxFlow = Math.max(...flows);
      const minFlow = Math.min(...flows);
      const totalVolume = flows.reduce((a, b) => a + b, 0) * 86400; // è½¬æ¢ä¸ºæ¯æ—¥ç«‹æ–¹ç±³
      
      // è®¡ç®—ç§»åŠ¨å¹³å‡
      const movingAvg = movingAverage(flows, 3);
      
      // æ£€æµ‹å³°å€¼
      const peaks = findPeaks(flows);
      
      analysisContent.innerHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
          <div>
            <h4>åŸºæœ¬ç»Ÿè®¡</h4>
            <p><strong>å¹³å‡å¾„æµ:</strong> ${avgFlow.toFixed(2)} mÂ³/s</p>
            <p><strong>æœ€å¤§å¾„æµ:</strong> ${maxFlow.toFixed(2)} mÂ³/s</p>
            <p><strong>æœ€å°å¾„æµ:</strong> ${minFlow.toFixed(2)} mÂ³/s</p>
            <p><strong>æ€»æ°´é‡:</strong> ${(totalVolume / 1000000).toFixed(2)} ç™¾ä¸‡ mÂ³</p>
          </div>
          <div>
            <h4>è¶‹åŠ¿åˆ†æ</h4>
            <p><strong>å³°å€¼æ•°é‡:</strong> ${peaks.length}</p>
            <p><strong>ä¸»è¦å³°å€¼:</strong> ${peaks.length > 0 ? Math.max(...peaks).toFixed(2) + ' mÂ³/s' : 'æ— '}</p>
            <p><strong>å˜åŒ–è¶‹åŠ¿:</strong> ${flows[flows.length-1] > flows[0] ? 'ä¸Šå‡' : 'ä¸‹é™'}</p>
            <p><strong>é¢„æµ‹ç½®ä¿¡åº¦:</strong> 85%</p>
          </div>
        </div>
        <div style="margin-top: 16px;">
          <h4>æ•°æ®æ¥æº</h4>
          <p><strong>ç®—æ³•:</strong> NeuralHydrology LSTMæ·±åº¦å­¦ä¹ æ¨¡å‹</p>
          <p><strong>æ•°æ®æº:</strong> ECCCç§¯é›ªæ•°æ® + HYDATå¾„æµæ•°æ® + NASA MODISç§¯é›ªè¦†ç›–</p>
          <p><strong>ä½œè€…:</strong> Sean Li</p>
          <p><strong>æ›´æ–°æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
        </div>
      `;
    }
    
    // ç§»åŠ¨å¹³å‡è®¡ç®—
    function movingAverage(data, window) {
      const result = [];
      for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - Math.floor(window / 2));
        const end = Math.min(data.length, i + Math.floor(window / 2) + 1);
        const avg = data.slice(start, end).reduce((a, b) => a + b, 0) / (end - start);
        result.push(avg);
      }
      return result;
    }
    
    // å³°å€¼æ£€æµ‹
    function findPeaks(data) {
      const peaks = [];
      for (let i = 1; i < data.length - 1; i++) {
        if (data[i] > data[i-1] && data[i] > data[i+1]) {
          peaks.push(data[i]);
        }
      }
      return peaks;
    }
    
    // å¯¼å‡ºPNG
    function exportPNG() {
      if (chart) {
        const link = document.createElement('a');
        link.download = 'forecast-chart.png';
        link.href = chart.canvas.toDataURL();
        link.click();
      }
    }
    
    // åˆ‡æ¢ç¼©æ”¾
    function toggleZoom() {
      zoomEnabled = !zoomEnabled;
      if (chart && chart.options.plugins.zoom) {
        chart.options.plugins.zoom.zoom.wheel.enabled = zoomEnabled;
        chart.options.plugins.zoom.zoom.pinch.enabled = zoomEnabled;
        chart.options.plugins.zoom.pan.enabled = zoomEnabled;
        chart.update();
      }
    }
    
    // é‡ç½®ç¼©æ”¾
    function resetZoom() {
      if (chart && chart.options.plugins.zoom) {
        chart.resetZoom();
      }
    }
  </script>
</body>
</html>


