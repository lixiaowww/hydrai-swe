<!DOCTYPE html>
<html>
<head>
    <title>å‰ç«¯æ˜¾ç¤ºæµ‹è¯•</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>æ•°æ®ç§‘å­¦åˆ†æAPIæµ‹è¯•</h1>
    
    <div id="anomaly-test" style="height: 400px; border: 1px solid #ccc; margin: 10px;"></div>
    <div id="decomposition-test" style="height: 400px; border: 1px solid #ccc; margin: 10px;"></div>
    <div id="factors-test" style="border: 1px solid #ccc; margin: 10px; padding: 10px;"></div>
    
    <script>
        async function testAPIs() {
            try {
                console.log('ğŸ§ª æµ‹è¯•å¼‚å¸¸æ£€æµ‹API...');
                const anomalyResponse = await fetch('http://localhost:8000/api/v1/data-science/anomaly-detection?column=snow_water_equivalent_mm');
                const anomalyData = await anomalyResponse.json();
                
                console.log('å¼‚å¸¸æ£€æµ‹æ•°æ®:', anomalyData);
                
                if (anomalyData.results && anomalyData.results.ensemble) {
                    const ensemble = anomalyData.results.ensemble;
                    const scores = ensemble.ensemble_scores || [];
                    const anomalies = ensemble.ensemble_anomalies || [];
                    const x = Array.from({length: scores.length}, (_, i) => i);
                    
                    console.log(`å¼‚å¸¸åˆ†æ•°é•¿åº¦: ${scores.length}, å¼‚å¸¸ç‚¹æ•°: ${anomalies.filter(a => a > 0).length}`);
                    
                    const traces = [
                        {x, y: scores, type:'scatter', mode:'lines', name:'å¼‚å¸¸åˆ†æ•°', line:{color:'blue'}},
                        {x, y: scores.map((v,i)=> anomalies[i] > 0 ? v : null), type:'scatter', mode:'markers', name:'å¼‚å¸¸ç‚¹', marker:{color:'red', size:8}}
                    ];
                    
                    Plotly.newPlot('anomaly-test', traces, {title:'å¼‚å¸¸æ£€æµ‹æµ‹è¯•', height:400});
                    console.log('âœ… å¼‚å¸¸æ£€æµ‹å›¾è¡¨æ¸²æŸ“æˆåŠŸ');
                } else {
                    console.error('âŒ å¼‚å¸¸æ£€æµ‹æ•°æ®æ ¼å¼é”™è¯¯');
                }
                
                console.log('ğŸ§ª æµ‹è¯•åˆ†è§£åˆ†æAPI...');
                const decompResponse = await fetch('http://localhost:8000/api/v1/data-science/decomposition?column=snow_water_equivalent_mm');
                const decompData = await decompResponse.json();
                
                console.log('åˆ†è§£åˆ†ææ•°æ®ç»“æ„:', Object.keys(decompData.results || {}));
                
                if (decompData.results && decompData.results.stl_decomposition) {
                    const stl = decompData.results.stl_decomposition;
                    const trend = stl.trend.values;
                    const x = Array.from({length: trend.length}, (_, i) => i);
                    
                    const traces = [
                        {x, y: trend, type:'scatter', mode:'lines', name:'è¶‹åŠ¿', line:{color:'green'}}
                    ];
                    
                    Plotly.newPlot('decomposition-test', traces, {title:'æ—¶é—´åºåˆ—åˆ†è§£æµ‹è¯•', height:400});
                    console.log('âœ… åˆ†è§£åˆ†æå›¾è¡¨æ¸²æŸ“æˆåŠŸ');
                }
                
                console.log('ğŸ§ª æµ‹è¯•å› å­å‘ç°API...');
                const factorsResponse = await fetch('http://localhost:8000/api/v1/data-science/factor-discovery?target=snow_water_equivalent_mm&top_k=10');
                const factorsData = await factorsResponse.json();
                
                console.log('å› å­å‘ç°æ•°æ®:', factorsData);
                
                if (factorsData.results && factorsData.results.high_predictive) {
                    const factors = factorsData.results.high_predictive;
                    let html = '<h3>é‡è¦å› å­</h3><ul>';
                    factors.forEach(f => {
                        html += `<li>${f.factor}: ç›¸å…³æ€§ ${f.correlation.toFixed(3)}</li>`;
                    });
                    html += '</ul>';
                    document.getElementById('factors-test').innerHTML = html;
                    console.log('âœ… å› å­å‘ç°æ˜¾ç¤ºæˆåŠŸ');
                }
                
            } catch (error) {
                console.error('âŒ æµ‹è¯•å¤±è´¥:', error);
            }
        }
        
        // é¡µé¢åŠ è½½åè¿è¡Œæµ‹è¯•
        window.onload = testAPIs;
    </script>
</body>
</html>


